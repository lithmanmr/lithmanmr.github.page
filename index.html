<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ==================== META TAGS ESENCIALES PWA ==================== -->
    <!-- ==================== META TAGS ESENCIALES PWA ==================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#003366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TopCal Pro">
    <meta name="application-name" content="TopCal Professional">

    <!-- ==================== FAVICON (Navegador) ==================== -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/monta√±a.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/monta√±a.png">
    <link rel="shortcut icon" href="assets/monta√±a.png">

    <!-- ==================== APPLE TOUCH ICONS (iOS - iPhone/iPad) ==================== -->
    <link rel="apple-touch-icon" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="57x57" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="60x60" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="72x72" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="114x114" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/monta√±a.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/monta√±a.png">

    <!-- ==================== ANDROID CHROME ICONS ==================== -->
    <link rel="icon" type="image/png" sizes="192x192" href="assets/monta√±a.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/monta√±a.png">

    <!-- ==================== MANIFEST.JSON (Configuraci√≥n Android) ==================== -->
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopCal - Cotizaciones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* PALETA DE COLORES CORPORATIVA */
        :root {
            --primary-color: #003366; /* Azul corporativo oscuro */
            --secondary-color: #00509E; /* Azul corporativo medio */
            --accent-color: #FF6B35; /* Naranja corporativo */
            --light-accent: #FF9E5F; /* Naranja claro */
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --light-bg: #F8F9FA;
            --dark-text: #333333;
            --light-text: #FFFFFF;
            --gray-border: #DEE2E6;
            --shadow-light: rgba(0, 51, 102, 0.1);
            --shadow-medium: rgba(0, 51, 102, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--light-bg);
            border-radius: 20px;
            box-shadow: 0 15px 50px var(--shadow-medium);
            overflow: hidden;
            border: 1px solid var(--gray-border);
        }

        /* HEADER MEJORADO */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text);
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><path d="M20,20 L80,20 L80,80 L20,80 Z" fill="none" stroke="white" stroke-width="2"/><circle cx="50" cy="50" r="15" fill="none" stroke="white" stroke-width="2"/></svg>');
            background-size: 300px;
            opacity: 0.1;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 700;
            position: relative;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .logo {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }

        /* TABS MEJORADAS */
        .tabs {
            display: flex;
            background: var(--light-bg);
            border-bottom: 2px solid var(--gray-border);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 20px 35px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab:hover {
            background: rgba(0, 80, 158, 0.05);
            color: var(--secondary-color);
        }

        .tab.active {
            background: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--accent-color);
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--accent-color);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .tab.active::after {
            width: 100%;
        }

        /* CONTENIDO DE TABS */
        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.5s ease-out;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* FORMULARIOS MEJORADOS */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
            color: var(--dark-text);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--shadow-light);
        }

        .form-group input::placeholder {
            color: #999;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }

        /* BOTONES MEJORADOS */
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px var(--shadow-medium);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #000;
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(23, 162, 184, 0.3);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--light-accent) 100%);
            color: white;
        }

        .btn-accent:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3);
        }

        /* TABLAS MEJORADAS */
        .table-container {
            overflow-x: auto;
            margin: 30px 0;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--shadow-light);
            border: 1px solid var(--gray-border);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
        }

        th:first-child {
            border-top-left-radius: 14px;
        }

        th:last-child {
            border-top-right-radius: 14px;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-border);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(0, 80, 158, 0.03);
        }

        /* BADGES MEJORADOS */
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-category {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--light-accent) 100%);
            color: white;
        }

        /* ALERTAS MEJORADAS */
        .alert {
            padding: 20px 25px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
            border-left: 5px solid;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        /* SUMMARY BOX MEJORADO */
        .summary-box {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }

        .summary-box::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }

        .summary-box h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            position: relative;
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h4 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card p {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 0;
        }

        /* LOADING MEJORADO */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 51, 102, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: white;
            font-size: 1.2rem;
            text-align: center;
            max-width: 300px;
        }

        /* FOOTER MEJORADO */
        .footer {
            background: var(--primary-color);
            color: white;
            padding: 30px;
            text-align: center;
            font-size: 14px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer p {
            margin: 5px 0;
            opacity: 0.9;
        }

        .footer a {
            color: var(--light-accent);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer a:hover {
            color: white;
            text-decoration: underline;
        }

        /* BOTONES DE ACCI√ìN */
        .delete-btn {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .categoria-header {
            background: rgba(0, 80, 158, 0.08);
            font-weight: bold;
            color: var(--primary-color);
            border-left: 4px solid var(--accent-color);
        }

        /* PROGRESS BAR */
        .progress-bar {
            height: 6px;
            background: var(--gray-border);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color) 0%, var(--light-accent) 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* TOOLTIPS */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* ========== RESPONSIVE DESIGN MEJORADO ========== */

        /* ========== RESPONSIVE DESIGN PROFESIONAL ========== */

        /* VARIABLES RESPONSIVAS */
        :root {
            --font-base: 16px;
            --spacing-unit: 1rem;
        }

        /* ========== TABLETS (768px - 1024px) ========== */
        @media (max-width: 1024px) {
            :root {
                --font-base: 15px;
                --spacing-unit: 0.9rem;
            }
            
            .container {
                margin: 10px;
                border-radius: 12px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .tab {
                padding: 15px 20px;
                font-size: 0.95rem;
            }
            
            .tab-content {
                padding: 25px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ========== M√ìVILES (hasta 768px) ========== */
        @media (max-width: 768px) {
            :root {
                --font-base: 14px;
                --spacing-unit: 0.8rem;
            }
            
            body {
                padding: 0;
                background: var(--light-bg);
            }
            
            .container {
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            
            /* HEADER COMPACTO */
            .header {
                padding: 25px 15px;
                border-radius: 0;
            }
            
            .logo {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                line-height: 1.2;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 0.9rem;
                line-height: 1.3;
            }
            
            /* NAVEGACI√ìN TIPO ACORDE√ìN */
            .tabs {
                display: none; /* Ocultamos tabs tradicionales */
            }
            
            .mobile-nav {
                display: block;
                background: white;
                border-bottom: 2px solid var(--gray-border);
            }
            
            .mobile-nav-toggle {
                width: 100%;
                padding: 18px 20px;
                background: white;
                border: none;
                border-bottom: 1px solid var(--gray-border);
                text-align: left;
                font-size: 1rem;
                font-weight: 600;
                color: var(--primary-color);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: space-between;
                transition: all 0.3s;
            }
            
            .mobile-nav-toggle:active {
                background: var(--light-bg);
            }
            
            .mobile-nav-toggle .icon {
                font-size: 1.3rem;
                transition: transform 0.3s;
            }
            
            .mobile-nav-toggle.active .icon {
                transform: rotate(180deg);
            }
            
            .mobile-nav-list {
                display: none;
                background: var(--light-bg);
            }
            
            .mobile-nav-list.active {
                display: block;
            }
            
            .mobile-nav-item {
                padding: 15px 20px;
                border-bottom: 1px solid var(--gray-border);
                background: white;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .mobile-nav-item:active {
                background: var(--light-bg);
                transform: scale(0.98);
            }
            
            .mobile-nav-item.active {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                color: white;
                font-weight: 700;
                border-left: 4px solid var(--accent-color);
            }
            
            .mobile-nav-item span:first-child {
                font-size: 1.2rem;
            }
            
            /* CONTENIDO COMPACTO */
            .tab-content {
                padding: 20px 15px;
            }
            
            .tab-content h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            
            /* FORMULARIOS T√ÅCTILES */
            .form-group {
                margin-bottom: 18px;
            }
            
            .form-group label {
                font-size: 0.85rem;
                margin-bottom: 6px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px; /* Evita zoom en iOS */
                border-radius: 8px;
                min-height: 48px; /* Tama√±o t√°ctil √≥ptimo */
            }
            
            textarea {
                min-height: 120px;
            }
            
            /* BOTONES T√ÅCTILES */
            .btn {
                width: 100%;
                margin: 8px 0;
                padding: 16px;
                font-size: 1rem;
                min-height: 52px;
                border-radius: 8px;
            }
            
            /* CONTENEDOR DE BOTONES */
            .text-center .btn {
                width: calc(100% - 10px);
                margin: 5px;
            }
            
            /* TABLAS COMO TARJETAS EN M√ìVIL */
            .table-container {
                margin: 15px -15px;
                width: calc(100% + 30px);
                border-radius: 0;
                border-left: none;
                border-right: none;
                overflow: visible;
                box-shadow: none;
            }
            
            table {
                display: none; /* Ocultamos tabla tradicional */
            }
            
            .mobile-card-list {
                display: block;
            }
            
            .mobile-card {
                background: white;
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                border-left: 4px solid var(--accent-color);
                animation: slideInUp 0.3s ease-out;
            }
            
            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .mobile-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--gray-border);
            }
            
            .mobile-card-category {
                background: linear-gradient(135deg, var(--accent-color) 0%, var(--light-accent) 100%);
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: 600;
            }
            
            .mobile-card-value {
                font-size: 1.1rem;
                font-weight: 700;
                color: var(--primary-color);
            }
            
            .mobile-card-body {
                margin: 10px 0;
            }
            
            .mobile-card-row {
                display: flex;
                justify-content: space-between;
                padding: 6px 0;
                font-size: 0.9rem;
            }
            
            .mobile-card-label {
                color: var(--textoClaro);
                font-weight: 500;
            }
            
            .mobile-card-data {
                color: var(--dark-text);
                font-weight: 600;
                text-align: right;
            }
            
            .mobile-card-footer {
                margin-top: 12px;
                padding-top: 10px;
                border-top: 1px solid var(--gray-border);
                display: flex;
                gap: 8px;
            }
            
            .mobile-card-footer .btn {
                width: auto;
                flex: 1;
                padding: 10px;
                font-size: 0.85rem;
                min-height: 42px;
            }
            
            /* SUMMARY CARDS EN COLUMNA */
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .summary-card {
                padding: 18px;
            }
            
            .summary-card p {
                font-size: 1.8rem;
            }
            
            /* STATS COMPACTAS */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card .number {
                font-size: 1.5rem;
            }
            
            .stat-card .label {
                font-size: 0.75rem;
            }
            
            /* ALERTAS COMPACTAS */
            .alert {
                padding: 12px 15px;
                margin: 12px 0;
                font-size: 0.9rem;
                border-radius: 8px;
            }
            
            /* NOTAS COMPACTAS */
            .notes {
                padding: 12px;
                margin: 12px 0;
                font-size: 0.85rem;
                border-radius: 8px;
            }
            
            /* FOOTER COMPACTO */
            .footer {
                padding: 20px 15px;
                font-size: 0.8rem;
            }
            
            .footer p {
                margin: 5px 0;
                line-height: 1.4;
            }
            
            /* PROGRESS BAR */
            .progress-bar {
                height: 4px;
                margin: 15px 0;
            }
            
            /* DROPDOWN PERSONALIZADO M√ìVIL */
            .custom-dropdown {
                position: fixed !important;
                left: 10px !important;
                right: 10px !important;
                max-height: 60vh;
                bottom: 0 !important;
                top: auto !important;
                border-radius: 15px 15px 0 0;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
                z-index: 9999;
            }
            
            .dropdown-option {
                padding: 15px;
                font-size: 0.95rem;
                min-height: 48px;
                display: flex;
                align-items: center;
            }
        }

        /* ========== M√ìVILES PEQUE√ëOS (menos de 576px) ========== */
        @media (max-width: 576px) {
            :root {
                --font-base: 13px;
            }
            
            .header {
                padding: 20px 12px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .header p {
                font-size: 0.85rem;
            }
            
            .tab-content {
                padding: 15px 12px;
            }
            
            .mobile-card {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            .mobile-card-value {
                font-size: 1rem;
            }
            
            .summary-card p {
                font-size: 1.5rem;
            }
            
            .btn {
                font-size: 0.9rem;
                padding: 14px;
            }
        }

        /* ========== LANDSCAPE (horizontal) ========== */
        @media (max-height: 600px) and (orientation: landscape) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.4rem;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .tab-content {
                padding: 15px;
                max-height: 75vh;
                overflow-y: auto;
            }
            
            .mobile-nav-toggle {
                padding: 12px 15px;
            }
            
            .mobile-nav-item {
                padding: 10px 15px;
            }
        }

        /* UTILITY CLASSES */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-accent {
            color: var(--accent-color);
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .hidden {
            display: none !important;
        }

        /* ANIMACIONES ADICIONALES */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* VALIDACIONES */
        input:invalid, select:invalid {
            border-color: var(--danger-color);
        }

        input:valid, select:valid {
            border-color: var(--success-color);
        }

        /* ESTILOS ESPEC√çFICOS PARA DATOS IMPORTANTES */
        .important-data {
            background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%);
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        /* ESTILOS PARA NOTAS */
        .notes {
            background: rgba(0, 80, 158, 0.05);
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .notes strong {
            color: var(--primary-color);
        }

        /* ESTILOS PARA ESTAD√çSTICAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px var(--shadow-light);
            border-top: 4px solid var(--accent-color);
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ESTILOS PARA VALIDACI√ìN EN TIEMPO REAL */
        .validation-message {
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .validation-message.error {
            color: var(--danger-color);
            display: block;
        }

        .validation-message.success {
            color: var(--success-color);
            display: block;
        }

        /* DROPDOWN PERSONALIZADO EDITABLE */
        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--accent-color);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .dropdown-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--gray-border);
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: var(--light-bg);
            color: var(--primary-color);
            font-weight: 600;
        }

        .dropdown-option.hidden {
            display: none;
        }

        /* RESET MEJORADO PARA RESPONSIVE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Mejor t√°ctil */
        }

        html {
            font-size: 16px; /* Base para rem */
            overflow-x: hidden; /* Previene scroll horizontal */
        }

        body {
            width: 100%;
            max-width: 100vw; /* Limita ancho m√°ximo */
            overflow-x: hidden;
            position: relative;
        }

        /* Control de visibilidad m√≥vil/desktop */
        @media (min-width: 769px) {
            .mobile-nav {
                display: none !important;
            }
            
            .tabs {
                display: flex !important;
            }
            
            .mobile-card-list {
                display: none !important;
            }
            
            table {
                display: table !important;
            }
        }
        
        @media (max-width: 768px) {
            .tabs {
                display: none !important;
            }
            
            .mobile-nav {
                display: block !important;
            }
            
            table {
                display: none !important;
            }
            
            .mobile-card-list {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üó∫Ô∏è</div>
            <h1>TopCal Professional</h1>
            <p>Sistema de Cotizaciones Topogr√°ficas - Generaci√≥n de Presupuestos Inteligentes</p>
            <div class="progress-bar mt-30">
                <div class="progress-fill" id="progressFill" style="width: 33%"></div>
            </div>
        </div>

        <!-- NAVEGACI√ìN M√ìVIL (solo visible en m√≥viles) -->
        <div class="mobile-nav" style="display: none;">
            <button class="mobile-nav-toggle" onclick="toggleMobileNav()">
                <span>üì± Men√∫ de Navegaci√≥n</span>
                <span class="icon">‚ñº</span>
            </button>
            <div class="mobile-nav-list" id="mobileNavList">
                <div class="mobile-nav-item active" onclick="showTabMobile(0)">
                    <span>üìã</span> <span>Datos Generales</span>
                </div>
                <div class="mobile-nav-item" onclick="showTabMobile(1)">
                    <span>üì¶</span> <span>Insumos</span>
                </div>
                <div class="mobile-nav-item" onclick="showTabMobile(2)">
                    <span>üí∞</span> <span>Presupuesto</span>
                </div>
                <div class="mobile-nav-item" onclick="showTabMobile(3)">
                    <span>‚öôÔ∏è</span> <span>Configuraci√≥n</span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab(0)">
                <span>üìã</span> Datos Generales
            </button>
            <button class="tab" onclick="showTab(1)">
                <span>üì¶</span> Insumos
            </button>
            <button class="tab" onclick="showTab(2)">
                <span>üí∞</span> Presupuesto
            </button>
            <button class="tab" onclick="showTab(3)">
                <span>‚öôÔ∏è</span> Configuraci√≥n
            </button>
        </div>

        <!-- TAB 1: DATOS GENERALES -->
        <div class="tab-content active">
            <h2 class="text-center mb-30" style="color: var(--primary-color);">
                <span>üìã</span> Informaci√≥n del Proyecto
            </h2>
            
            <div class="notes">
                <strong>üí° Nota:</strong> Complete todos los campos obligatorios (*) para generar una cotizaci√≥n precisa.
                Los datos se guardan autom√°ticamente en su navegador.
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre o Raz√≥n Social *</label>
                    <input type="text" id="nombreEmpresa" placeholder="Ingrese nombre o raz√≥n social" required>
                    <div class="validation-message error" id="nombreEmpresaError"></div>
                </div>
                <div class="form-group">
                    <label>Cliente *</label>
                    <input type="text" id="cliente" placeholder="Nombre del cliente o empresa" required>
                    <div class="validation-message error" id="clienteError"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Email de Contacto *</label>
                    <input type="email" id="email" placeholder="correo@ejemplo.com" required>
                    <div class="validation-message error" id="emailError"></div>
                </div>
                <div class="form-group">
                    <label>Tel√©fono *</label>
                    <input type="tel" id="telefono" placeholder="+51 999 999 999" required>
                    <div class="validation-message error" id="telefonoError"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Ubicaci√≥n del Proyecto *</label>
                <input type="text" id="ubicacion" placeholder="Direcci√≥n completa del proyecto" required>
                <div class="validation-message error" id="ubicacionError"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Descripci√≥n del Trabajo *</label>
                    <div style="position: relative;">
                        <input type="text" id="descripcionTrabajo" 
                            placeholder="Selecciona o escribe..." 
                            required
                            autocomplete="off"
                            onfocus="mostrarOpciones('descripcionTrabajo')"
                            oninput="filtrarOpciones('descripcionTrabajo')">
                        <div id="descripcionTrabajo-dropdown" class="custom-dropdown" style="display: none;">
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Levantamiento topogr√°fico')">Levantamiento topogr√°fico</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Replanteo')">Replanteo</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Reconocimiento de campo')">Reconocimiento de campo</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Instalaci√≥n de puntos geod√©sicos')">Instalaci√≥n de puntos geod√©sicos</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Asesor√≠a t√©cnica')">Asesor√≠a t√©cnica</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Topograf√≠a minera')">Topograf√≠a minera</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Cartograf√≠a digital')">Cartograf√≠a digital</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Supervisi√≥n topogr√°fica')">Supervisi√≥n topogr√°fica</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('descripcionTrabajo', 'Otros')">Otros</div>
                        </div>
                    </div>
                    <div class="validation-message error" id="descripcionTrabajoError"></div>
                </div>
                <div class="form-group">
                    <label>Tipo de Proyecto *</label>
                    <div style="position: relative;">
                        <input type="text" id="tipoProyecto" 
                            placeholder="Selecciona o escribe..." 
                            required
                            autocomplete="off"
                            onfocus="mostrarOpciones('tipoProyecto')"
                            oninput="filtrarOpciones('tipoProyecto')">
                        <div id="tipoProyecto-dropdown" class="custom-dropdown" style="display: none;">
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Construcci√≥n de Carreteras')">Construcci√≥n de Carreteras</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Construcci√≥n de Edificaciones')">Construcci√≥n de Edificaciones</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Miner√≠a')">Miner√≠a</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Alcantarillado')">Alcantarillado</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Infraestructura Ferroviaria')">Infraestructura Ferroviaria</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Proyectos Hidr√°ulicos')">Proyectos Hidr√°ulicos</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Catastro')">Catastro</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Habilitaciones Urbanas')">Habilitaciones Urbanas</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Energ√≠a y Electricidad')">Energ√≠a y Electricidad</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Agricultura y Riego')">Agricultura y Riego</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('tipoProyecto', 'Otros')">Otros</div>
                        </div>
                    </div>
                    <div class="validation-message error" id="tipoProyectoError"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Fecha de Cotizaci√≥n *</label>
                    <input type="date" id="fecha" required>
                    <div class="validation-message error" id="fechaError"></div>
                </div>
                <div class="form-group">
                    <label>Plazo de Entrega *</label>
                    <input type="text" id="plazo" placeholder="Ej: 15 d√≠as h√°biles" required>
                    <div class="validation-message error" id="plazoError"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Dimensiones del Proyecto (Metrado)</label>
                    <input type="text" id="metrado" placeholder="Ej: 1500 m¬≤, 5000 m lineales, etc.">
                </div>
                <div class="form-group">
                    <label>Moneda *</label>
                    <select id="moneda" required>
                        <option value="Soles">Soles (PEN - S/.)</option>
                        <option value="D√≥lares">D√≥lares Americanos (USD - $)</option>
                        <option value="Euros">Euros (EUR - ‚Ç¨)</option>
                    </select>
                    <div class="validation-message error" id="monedaError"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Observaciones Adicionales</label>
                <textarea id="observaciones" rows="4" placeholder="Agregue cualquier observaci√≥n o detalle adicional importante..."></textarea>
            </div>

            <div class="stats-grid" id="datosStats">
                <div class="stat-card">
                    <div class="number" id="camposCompletados">0</div>
                    <div class="label">Campos Completados</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="camposObligatorios">0</div>
                    <div class="label">Campos Obligatorios</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="progresoDatos">0%</div>
                    <div class="label">Progreso</div>
                </div>
            </div>

            <div class="text-center mt-30">
                <button class="btn btn-success" onclick="guardarDatosGenerales()">
                    <span>üíæ</span> Guardar Datos
                </button>
                <button class="btn btn-info" onclick="cargarDatosGenerales()">
                    <span>üìÇ</span> Cargar Datos
                </button>
                <button class="btn btn-accent" onclick="validarFormularioDatos()">
                    <span>‚úÖ</span> Validar Datos
                </button>
            </div>

            <div id="alertDatosGenerales"></div>
        </div>

        <!-- TAB 2: INSUMOS -->
        <div class="tab-content">
            <h2 class="text-center mb-30" style="color: var(--primary-color);">
                <span>üì¶</span> Gesti√≥n de Insumos y Recursos
            </h2>
            
            <div class="notes">
                <strong>üí° Tip:</strong> Agregue todos los insumos necesarios para su proyecto. 
                Puede agrupar por categor√≠as y los costos se calcular√°n autom√°ticamente.
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Categor√≠a *</label>
                    <div style="position: relative;">
                        <input type="text" id="categoria" 
                            placeholder="Selecciona o escribe..." 
                            required
                            autocomplete="off"
                            onfocus="mostrarOpciones('categoria')"
                            oninput="filtrarOpciones('categoria'); actualizarDescripciones();">
                        <div id="categoria-dropdown" class="custom-dropdown" style="display: none;">
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Transporte')">Transporte</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Hospedaje')">Hospedaje</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Alimentaci√≥n')">Alimentaci√≥n</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Mano de Obra')">Mano de Obra</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Herramientas y materiales')">Herramientas y materiales</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Equipos de oficina')">Equipos de oficina</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Equipos topogr√°ficos')">Equipos topogr√°ficos</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Dise√±o')">Dise√±o</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Permisos y licencias')">Permisos y licencias</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('categoria', 'Utilidad')">Utilidad</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n *</label>
                    <div style="position: relative;">
                        <input type="text" id="descripcion" 
                            placeholder="Selecciona o escribe..." 
                            required
                            autocomplete="off"
                            onfocus="mostrarOpciones('descripcion')"
                            oninput="filtrarOpciones('descripcion')">
                        <div id="descripcion-dropdown" class="custom-dropdown" style="display: none;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Unidad de Medida *</label>
                    <div style="position: relative;">
                        <input type="text" id="unidad" 
                            placeholder="Selecciona o escribe..." 
                            required
                            autocomplete="off"
                            onfocus="mostrarOpciones('unidad')"
                            oninput="filtrarOpciones('unidad')">
                        <div id="unidad-dropdown" class="custom-dropdown" style="display: none;">
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', '%mo')">%mo</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'bal')">bal</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'd√≠a')">d√≠a</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', '%m')">%m</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'glb')">glb</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', '%')">%</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'hja')">hja</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'km')">km</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'l')">l</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'm¬≤')">m¬≤</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'm¬≥')">m¬≥</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'mes')">mes</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'm')">m</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'kg')">kg</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'num')">num</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'bol')">bol</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'und')">und</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'pje')">pje</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'ha')">ha</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'lt')">lt</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'mz')">mz</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'gal')">gal</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'ft¬≤')">ft¬≤</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'in')">in</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'lb')">lb</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'ft¬≥')">ft¬≥</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'est')">est</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'hr')">hr</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'min')">min</div>
                            <div class="dropdown-option" onclick="seleccionarOpcion('unidad', 'sem')">sem</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Cantidad *</label>
                <input type="number" id="cantidad" step="0.01" min="0.01" placeholder="0.00" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Costo Unitario *</label>
                    <input type="number" id="costoUnitario" step="0.01" min="0" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label>Margen de Utilidad (%)</label>
                    <input type="number" id="margenUtilidad" step="0.1" min="0" max="100" placeholder="20">
                </div>
            </div>

            <div class="form-group">
                <label>Notas Adicionales del Insumo</label>
                <input type="text" id="notasInsumo" placeholder="Observaciones espec√≠ficas de este √≠tem...">
            </div>

            <div class="text-center mt-20">
                <button class="btn btn-primary" onclick="agregarInsumo()">
                    <span>‚ûï</span> Agregar Insumo
                </button>
                <button class="btn btn-info" onclick="agregarInsumoRapido()">
                    <span>‚ö°</span> Agregar R√°pido
                </button>
            </div>

            <div id="alertInsumos"></div>

            <div class="stats-grid mt-30">
                <div class="stat-card">
                    <div class="number" id="totalInsumos">0</div>
                    <div class="label">Total Insumos</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="categoriasUnicas">0</div>
                    <div class="label">Categor√≠as</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="subtotalInsumos">0.00</div>
                    <div class="label">Subtotal</div>
                </div>
            </div>

            <h3 class="mt-30 mb-20" style="color: var(--primary-color);">
                <span>üìä</span> Lista de Insumos Registrados
            </h3>
            <div class="table-container">
                <table id="tablaInsumos" class="responsive-table">
                    <thead>
                        <tr>
                            <th>Categor√≠a</th>
                            <th>Descripci√≥n</th>
                            <th>Unidad</th>
                            <th>Cantidad</th>
                            <th>Costo Unit.</th>
                            <th>Utilidad</th>
                            <th>Parcial</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="insumosBody"></tbody>
                </table>
            </div>

            <div class="text-center mt-30">
                <button class="btn btn-success" onclick="guardarInsumos()">
                    <span>üíæ</span> Guardar Lista
                </button>
                <button class="btn btn-info" onclick="cargarInsumos()">
                    <span>üìÇ</span> Cargar Lista
                </button>
                <button class="btn btn-danger" onclick="limpiarTodo()">
                    <span>üóëÔ∏è</span> Limpiar Todo
                </button>
            </div>
        </div>

        <!-- TAB 3: PRESUPUESTO -->
        <div class="tab-content">
            <h2 class="text-center mb-30" style="color: var(--primary-color);">
                <span>üí∞</span> Presupuesto Final y Cotizaci√≥n
            </h2>
            
            <div class="notes">
                <strong>üìà Generaci√≥n Inteligente:</strong> El sistema calcula autom√°ticamente subtotales, impuestos, 
                utilidad y genera un presupuesto profesional listo para enviar al cliente.
            </div>

            <div class="text-center mt-20 mb-30">
                <button class="btn btn-accent pulse" onclick="generarPresupuesto()">
                    <span>üîÑ</span> Generar Presupuesto Completo
                </button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="incluirIGV" checked onchange="generarPresupuesto()">
                        Incluir IGV (18%)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="incluirUtilidad" checked onchange="generarPresupuesto()">
                        Incluir Margen de Utilidad (%)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="mostrarDesglose" checked onchange="generarPresupuesto()">
                        Mostrar Desglose Completo
                    </label>
                </div>
            </div>

            <div class="important-data">
                <h4 style="margin-bottom: 10px; color: var(--accent-color);">
                    <span>üìã</span> Informaci√≥n del Proyecto
                </h4>
                <div id="infoProyectoResumen">Complete los datos generales primero</div>
            </div>

            <div id="resumenPresupuesto"></div>

            <div class="table-container">
                <table id="tablaPresupuesto">
                    <thead>
                        <tr>
                            <th>√çtem</th>
                            <th>Descripci√≥n</th>
                            <th>Unidad</th>
                            <th>Cantidad</th>
                            <th>Costo Unit.</th>
                            <th>Subtotal</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="presupuestoBody"></tbody>
                </table>
            </div>

            <div class="stats-grid mt-30">
                <div class="stat-card">
                    <div class="number" id="totalItems">0</div>
                    <div class="label">√çtems Totales</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalCategorias">0</div>
                    <div class="label">Categor√≠as</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalPresupuesto">0.00</div>
                    <div class="label">Presupuesto Total</div>
                </div>
            </div>

            <div class="text-center mt-30">
                <button class="btn btn-success" onclick="exportarPDF()">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                </button>
                <button class="btn btn-info" onclick="generarPropuesta()">
                    <i class="fas fa-file-alt"></i> Generar Propuesta
                </button>
                <button class="btn btn-primary" onclick="compartirPresupuesto()">
                    <i class="fas fa-share-alt"></i> Compartir
                </button>
            </div>

            <div id="alertPresupuesto"></div>
        </div>

        <!-- TAB 4: CONFIGURACI√ìN -->
        <div class="tab-content">
            <h2 class="text-center mb-30" style="color: var(--primary-color);">
                <span>‚öôÔ∏è</span> Configuraci√≥n del Sistema
            </h2>
            
            <div class="notes">
                <strong>üîß Personalizaci√≥n:</strong> Configure los par√°metros del sistema seg√∫n sus necesidades.
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Porcentaje de IGV</label>
                    <input type="number" id="configIGV" step="0.1" min="0" max="100" value="18" placeholder="18">
                </div>
                <div class="form-group">
                    <label>Margen de Utilidad Predeterminado (%)</label>
                    <input type="number" id="configUtilidad" step="0.1" min="0" max="100" value="20" placeholder="20">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>RUC / NIT</label>
                    <input type="text" id="configRUC" placeholder="N√∫mero de identificaci√≥n tributaria">
                </div>
            </div>

            <div class="text-center mt-30">
                <button class="btn btn-success" onclick="guardarConfiguracion()">
                    <span>üíæ</span> Guardar Configuraci√≥n
                </button>
                <button class="btn btn-warning" onclick="aplicarMargenActualATodos()">
                    <span>üìä</span> Aplicar a Todos los Insumos
                </button>
                <button class="btn btn-danger" onclick="resetearConfiguracion()">
                    <span>üîÑ</span> Restablecer Valores
                </button>
            </div>

            <!-- ***** AQU√ç AGREGA EL CONTENEDOR DE ALERTAS ***** -->
            <div id="configAlert" class="mt-20"></div>

            <div class="important-data mt-30">
                <h4 style="margin-bottom: 10px; color: var(--accent-color);">
                    <span>üìä</span> Estad√≠sticas del Sistema
                </h4>
                <div id="estadisticasSistema">
                    Cargando estad√≠sticas...
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>TopCal v2.0</strong> - Sistema de Cotizaciones Topogr√°ficas</p>
            <p>Powered by Lithman Morales | ¬© 2026 - Todos los derechos reservados</p>
            <p>
                <a href="#" onclick="mostrarAcercaDe()">Acerca de</a>
            </p>
        </div>
    </div>

    <div class="loading" id="loadingPDF">
        <div class="spinner"></div>
        <p>Generando documento PDF profesional...</p>
        <p id="loadingStatus" style="font-size: 14px; opacity: 0.8;">Preparando contenido</p>
        <div class="progress-bar" style="width: 300px; margin-top: 20px;">
            <div class="progress-fill" id="loadingProgress" style="width: 0%"></div>
        </div>
    </div>

    <script>
        // ========== VARIABLES GLOBALES ==========
        let insumos = [];
        let datosGenerales = {};
        let configuracion = {
            igv: 18,
            utilidad: 20,
            ruc: ''
        };

        // AGREGAR ESTA L√çNEA:
        const logoRuta = 'assets/monta√±a.png'; // Ruta del logo

        // ========== DATOS DE CONFIGURACI√ìN ==========
        const descripciones = {
            "Transporte": ["Pasaje bus", "Pasaje camioneta", "Pasaje auto", "Pasaje avi√≥n", 
                        "Alquiler camioneta", "Alquiler auto", "Taxi", "Combustible"],
            "Hospedaje": ["B√°sico", "Regular", "Bueno", "Premium"],
            "Alimentaci√≥n": ["Alimentaci√≥n zona urbana", "Alimentaci√≥n zona rural", 
                        "Vi√°ticos", "Refrigerios"],
            "Mano de Obra": ["Ingeniero top√≥grafo", "Ingeniero de minas", "Ingeniero ge√≥logo", 
                        "Ingeniero agr√≠cola", "Ingeniero civil", "Cadista", "Top√≥grafo", 
                        "Operador de equipo GNSS", "Operador Drone", "Operador Estacion total", 
                        "Operador Teodolito", "Operador Nivel de ingeniero", "Ayudante", 
                        "Chofer", "Practicante", "Otros"],
            "Herramientas y materiales": ["Spray", "Dianas", "Taladro", "Epp", "Clavos", 
                                        "Estacas", "Martillo", "Arena", "Cemento", "Grava", 
                                        "Libreta de campo", "Radio de comunicaci√≥n", 
                                        "Pegamento madera", "Cinta m√©trica", "Flex√≥metro", 
                                        "Escuadras", "Pinturas", "Brochas", "Otros"],
            "Equipos de oficina": ["Calculadora cient√≠fica", "Impresora", "Archivos para informes", 
                                "PC o laptop I7-Amd7", "Lapiceros", "C√°mara", "Hojas A4", 
                                "Papel para planos", "Toner", "USB", "Disco duro", "otros"],
            "Equipos topogr√°ficos": ["Estaci√≥n total", "Receptor GNSS", "Drone (RPAS)", 
                                "Teodolito", "Nivel de ingeniero", "Br√∫jula", "GPS Navegador", 
                                "Prisma", "Esc√°ner l√°ser", "Tablet", "Miras topogr√°ficas", 
                                "Bater√≠as", "Pilas", "Tr√≠podes", "Bastones", "otros"],
            "Dise√±o": ["Plano perim√©trico", "Plano topogr√°fico", "Plano de poligonal", 
                    "Plano de BM's", "Plano de calicatas", "Plano de ubicaci√≥n y localizaci√≥n", 
                    "Plano de subdivisi√≥n", "Plano de trazo de carreteras", 
                    "Plano de secci√≥n de t√∫neles", "Plano de pozos de oxidaci√≥n", 
                    "Plano de plataformas", "Plano de movimientos de tierra", 
                    "Plano de lotizaci√≥n", "Plano de canal de riego", "Plano de saneamiento", 
                    "Plano de parcelas", "Plano de catastro", "Plano defensa ribere√±a", 
                    "Plano de habilitaciones urbanas", "Expediente t√©cnico de puntos geod√©sicos", 
                    "Modelado 3D", "Ortofoto", "Otros"],
            "Permisos y licencias": ["Punto geod√©sico de orden A", "Punto geod√©sico de orden B", 
                                "Punto geod√©sico de orden C", "Datos ERP", "Data cruda", 
                                "Certificaciones", "Entradas", "Permisos municipales", 
                                "Autorizaciones", "Otros"],
            "Utilidad": [
                "Margen de utilidad est√°ndar", 
                "Utilidad por complejidad", 
                "Utilidad por riesgo"
            ]
        };

        // ========== FUNCIONES DEL SISTEMA ==========

        // ========== FUNCIONES DROPDOWN EDITABLE ==========

        function mostrarOpciones(campoId) {
            const dropdown = document.getElementById(campoId + '-dropdown');
            if (dropdown) {
                // Ocultar otros dropdowns
                document.querySelectorAll('.custom-dropdown').forEach(d => {
                    if (d.id !== campoId + '-dropdown') d.style.display = 'none';
                });
                dropdown.style.display = 'block';
                
                // Mostrar todas las opciones al abrir
                dropdown.querySelectorAll('.dropdown-option').forEach(opt => {
                    opt.classList.remove('hidden');
                });
            }
        }

        // ========== FUNCI√ìN PARA COMPARTIR PDF EN M√ìVIL ==========
        async function compartirPDFMovil(pdfBlob, nombreArchivo) {
            try {
                // 1. Verificar si el navegador soporta compartir archivos
                if (navigator.share && navigator.canShare) {
                    
                    // 2. Convertir el Blob del PDF en un archivo File
                    const pdfFile = new File([pdfBlob], nombreArchivo, { 
                        type: 'application/pdf',
                        lastModified: new Date().getTime()
                    });
                    
                    // 3. Verificar si se puede compartir este tipo de archivo
                    if (navigator.canShare({ files: [pdfFile] })) {
                        
                        // 4. Abrir el men√∫ nativo de compartir
                        await navigator.share({
                            title: 'Cotizaci√≥n TopCal',
                            text: `Cotizaci√≥n generada por TopCal Professional`,
                            files: [pdfFile]
                        });
                        
                        // 5. Si se comparti√≥ exitosamente
                        showAlert('alertPresupuesto', 
                            '‚úÖ PDF compartido correctamente', 
                            'success');
                        
                    } else {
                        // El navegador no puede compartir archivos PDF
                        throw new Error('Tu navegador no puede compartir archivos PDF');
                    }
                    
                } else {
                    // El navegador no soporta Web Share API
                    throw new Error('Funci√≥n de compartir no disponible en este navegador');
                }
                
            } catch (error) {
                // Si hubo alg√∫n error o el usuario cancel√≥
                if (error.name === 'AbortError') {
                    // El usuario cancel√≥ el compartir
                    showAlert('alertPresupuesto', 
                        '‚ÑπÔ∏è Compartir cancelado', 
                        'info');
                } else {
                    // Otro error - ofrecer alternativa
                    console.error('Error al compartir:', error);
                    
                    // PLAN B: Descargar el archivo
                    const fallbackDescargar = confirm(
                        'No se puede compartir directamente.\n\n' +
                        '¬øDeseas descargar el PDF para compartirlo manualmente?'
                    );
                    
                    if (fallbackDescargar) {
                        const pdfUrl = URL.createObjectURL(pdfBlob);
                        const link = document.createElement('a');
                        link.href = pdfUrl;
                        link.download = nombreArchivo;
                        link.click();
                        URL.revokeObjectURL(pdfUrl);
                        
                        showAlert('alertPresupuesto', 
                            'üíæ PDF descargado. Ahora puedes compartirlo desde tus archivos.', 
                            'info');
                    }
                }
            }
        }

        function seleccionarOpcion(campoId, valor) {
            const input = document.getElementById(campoId);
            input.value = valor;
            
            // Cerrar dropdown
            const dropdown = document.getElementById(campoId + '-dropdown');
            if (dropdown) dropdown.style.display = 'none';
            
            // Si es categor√≠a, actualizar descripciones
            if (campoId === 'categoria') {
                actualizarDescripciones();
            }
            
            // Trigger validation
            input.dispatchEvent(new Event('input'));
        }

        function filtrarOpciones(campoId) {
            const input = document.getElementById(campoId);
            const dropdown = document.getElementById(campoId + '-dropdown');
            
            if (!dropdown) return;
            
            const filtro = input.value.toLowerCase();
            const opciones = dropdown.querySelectorAll('.dropdown-option');
            
            let hayResultados = false;
            
            opciones.forEach(opcion => {
                const texto = opcion.textContent.toLowerCase();
                if (texto.includes(filtro)) {
                    opcion.classList.remove('hidden');
                    hayResultados = true;
                } else {
                    opcion.classList.add('hidden');
                }
            });
            
            // Mostrar dropdown si hay resultados
            dropdown.style.display = hayResultados ? 'block' : 'none';
        }

        // Cerrar dropdowns al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.matches('input[onfocus*="mostrarOpciones"]')) {
                document.querySelectorAll('.custom-dropdown').forEach(d => {
                    d.style.display = 'none';
                });
            }
        });

        // ========== FUNCI√ìN PARA CERRAR MODAL PDF ==========
        function cerrarModal(pdfUrl) {
            // Buscar el modal
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            
            if (modal) {
                // Limpiar URL del PDF
                if (pdfUrl) {
                    URL.revokeObjectURL(pdfUrl);
                }
                
                // Remover el modal con animaci√≥n
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s ease';
                
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Funci√≥n para cambiar pesta√±as
        function showTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            tabs[index].classList.add('active');
            contents[index].classList.add('active');
            
            // Actualizar barra de progreso
            const progress = ((index + 1) / tabs.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            if (index === 1) {
                actualizarEstadisticasInsumos();
            } else if (index === 2) {
                generarPresupuesto();
                actualizarInfoProyecto();
            } else if (index === 3) {
                actualizarEstadisticasSistema();
            }
        }

        // Navegaci√≥n m√≥vil
        function toggleMobileNav() {
            const navList = document.getElementById('mobileNavList');
            const toggle = document.querySelector('.mobile-nav-toggle');
            
            navList.classList.toggle('active');
            toggle.classList.toggle('active');
        }
        
        function showTabMobile(index) {
            // Cerrar men√∫ m√≥vil
            const navList = document.getElementById('mobileNavList');
            const toggle = document.querySelector('.mobile-nav-toggle');
            navList.classList.remove('active');
            toggle.classList.remove('active');
            
            // Actualizar items activos del men√∫ m√≥vil
            document.querySelectorAll('.mobile-nav-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Mostrar tab
            showTab(index);
            
            // Scroll al inicio
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Funci√≥n para mostrar alertas mejoradas
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const icon = type === 'success' ? '‚úÖ' : 
                       type === 'error' ? '‚ùå' : 
                       type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            container.innerHTML = `
                <div class="alert alert-${type}">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span style="font-size: 20px;">${icon}</span>
                        <div style="flex: 1;">
                            ${message}
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Funci√≥n para actualizar descripciones
        // Funci√≥n para actualizar descripciones
        function actualizarDescripciones() {
            const categoria = document.getElementById('categoria').value;
            const dropdown = document.getElementById('descripcion-dropdown');
            
            if (!dropdown) return;
            
            dropdown.innerHTML = '';
            
            if (categoria && descripciones[categoria]) {
                descripciones[categoria].forEach(desc => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = desc;
                    option.onclick = function() {
                        seleccionarOpcion('descripcion', desc);
                    };
                    dropdown.appendChild(option);
                });
            } else {
                dropdown.innerHTML = '<div class="dropdown-option" style="color: #999; cursor: default;">Seleccione categor√≠a primero</div>';
            }
        }

        // ========== FUNCIONES DATOS GENERALES ==========

        function validarFormularioDatos() {
            let valid = true;
            const requiredFields = ['nombreEmpresa', 'cliente', 'email', 'telefono', 'ubicacion', 
                                  'descripcionTrabajo', 'tipoProyecto', 'fecha', 'plazo', 'moneda'];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(fieldId + 'Error');
                
                if (!field.value.trim()) {
                    field.style.borderColor = 'var(--danger-color)';
                    if (errorElement) {
                        errorElement.textContent = 'Este campo es obligatorio';
                        errorElement.className = 'validation-message error';
                    }
                    valid = false;
                } else {
                    field.style.borderColor = 'var(--success-color)';
                    if (errorElement) {
                        errorElement.textContent = '‚úì Campo v√°lido';
                        errorElement.className = 'validation-message success';
                    }
                }
                
                // Validaci√≥n espec√≠fica para email
                if (fieldId === 'email' && field.value.trim()) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(field.value.trim())) {
                        field.style.borderColor = 'var(--danger-color)';
                        if (errorElement) {
                            errorElement.textContent = 'Ingrese un email v√°lido';
                            errorElement.className = 'validation-message error';
                        }
                        valid = false;
                    }
                }
            });
            
            if (valid) {
                showAlert('alertDatosGenerales', '‚úÖ Todos los campos obligatorios est√°n completos y v√°lidos', 'success');
            } else {
                showAlert('alertDatosGenerales', '‚ö†Ô∏è Revise los campos marcados en rojo', 'warning');
            }
            
            actualizarEstadisticasDatos();
            return valid;
        }

        function actualizarEstadisticasDatos() {
            const fields = document.querySelectorAll('#tab-1 input[required], #tab-1 select[required]');
            let completed = 0;
            
            fields.forEach(field => {
                if (field.value.trim()) completed++;
            });
            
            const total = fields.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('camposCompletados').textContent = completed;
            document.getElementById('camposObligatorios').textContent = total;
            document.getElementById('progresoDatos').textContent = `${percentage}%`;
        }

        function guardarDatosGenerales() {
            try {
                if (!validarFormularioDatos()) {
                    showAlert('alertDatosGenerales', '‚ùå Complete todos los campos obligatorios correctamente', 'error');
                    return;
                }

                datosGenerales = {
                    nombreEmpresa: document.getElementById('nombreEmpresa').value.trim(),
                    cliente: document.getElementById('cliente').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    telefono: document.getElementById('telefono').value.trim(),
                    ubicacion: document.getElementById('ubicacion').value.trim(),
                    descripcionTrabajo: document.getElementById('descripcionTrabajo').value,
                    tipoProyecto: document.getElementById('tipoProyecto').value,
                    fecha: document.getElementById('fecha').value,
                    plazo: document.getElementById('plazo').value.trim(),
                    metrado: document.getElementById('metrado').value.trim(),
                    moneda: document.getElementById('moneda').value,
                    observaciones: document.getElementById('observaciones').value.trim()
                };

                localStorage.setItem('topcal_datos_v2', JSON.stringify(datosGenerales));
                
                // Crear copia de seguridad
                const backup = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    datos: datosGenerales
                };
                localStorage.setItem('topcal_backup_datos', JSON.stringify(backup));
                
                showAlert('alertDatosGenerales', 
                    `‚úÖ Datos guardados correctamente<br>
                    <small>${new Date().toLocaleString()}</small>`, 
                    'success');
                    
                actualizarEstadisticasDatos();
            } catch (error) {
                showAlert('alertDatosGenerales', 
                    `‚ùå Error al guardar: ${error.message}<br>
                    <small>Verifique que tiene espacio en el navegador</small>`, 
                    'error');
            }
        }

        function cargarDatosGenerales() {
            try {
                const datos = localStorage.getItem('topcal_datos_v2');
                if (!datos) {
                    const datosViejo = localStorage.getItem('topcal_datos');
                    if (datosViejo) {
                        datosGenerales = JSON.parse(datosViejo);
                    } else {
                        showAlert('alertDatosGenerales', '‚ö†Ô∏è No hay datos guardados previamente', 'warning');
                        return;
                    }
                } else {
                    datosGenerales = JSON.parse(datos);
                }

                // Cargar todos los campos
                Object.keys(datosGenerales).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = datosGenerales[key];
                        } else {
                            element.value = datosGenerales[key] || '';
                        }
                    }
                });

                showAlert('alertDatosGenerales', 
                    `‚úÖ Datos cargados correctamente<br>
                    <small>Cliente: ${datosGenerales.cliente}</small>`, 
                    'success');
                    
                actualizarEstadisticasDatos();
            } catch (error) {
                showAlert('alertDatosGenerales', 
                    `‚ùå Error al cargar: ${error.message}<br>
                    <small>Intente limpiar el almacenamiento local</small>`, 
                    'error');
            }
        }

        // ========== FUNCIONES INSUMOS ==========

        function agregarInsumo() {
            try {
                const categoria = document.getElementById('categoria').value;
                const descripcion = document.getElementById('descripcion').value;
                const unidad = document.getElementById('unidad').value;
                const cantidad = parseFloat(document.getElementById('cantidad').value);
                const costoUnitario = parseFloat(document.getElementById('costoUnitario').value);
                
                // TOMA SOLO EL VALOR DEL CAMPO, NO DE LA CONFIGURACI√ìN
                const margenUtilidadInput = document.getElementById('margenUtilidad');
                let margenUtilidad = 20; // Valor por defecto
                
                if (margenUtilidadInput && margenUtilidadInput.value !== '' && !isNaN(parseFloat(margenUtilidadInput.value))) {
                    margenUtilidad = parseFloat(margenUtilidadInput.value);
                } else if (configuracion && configuracion.utilidad) {
                    margenUtilidad = parseFloat(configuracion.utilidad);
                }
                
                const notas = document.getElementById('notasInsumo').value.trim();

                if (!categoria || !descripcion || !unidad || isNaN(cantidad) || isNaN(costoUnitario)) {
                    showAlert('alertInsumos', '‚ö†Ô∏è Complete todos los campos obligatorios correctamente', 'error');
                    return;
                }

                if (cantidad <= 0 || costoUnitario < 0) {
                    showAlert('alertInsumos', '‚ö†Ô∏è La cantidad y costo deben ser valores positivos', 'error');
                    return;
                }

                // VERIFICACI√ìN PARA DEBUG
                console.log('üîç Margen de utilidad usado en nuevo insumo:', margenUtilidad + '%');
                
                const subtotal = cantidad * costoUnitario;
                const utilidad = subtotal * (margenUtilidad / 100);
                const parcial = subtotal + utilidad;

                insumos.push({
                    id: Date.now() + Math.random(),
                    categoria,
                    descripcion,
                    unidad,
                    cantidad,
                    costoUnitario,
                    margenUtilidad, // ¬°GUARDAR EL PORCENTAJE REAL!
                    subtotal,
                    utilidad,
                    parcial,
                    notas,
                    fechaRegistro: new Date().toISOString()
                });
                
                mostrarInsumos();
                limpiarFormularioInsumos();
                guardarInsumosAuto();
                actualizarEstadisticasInsumos();
                
                showAlert('alertInsumos', 
                    `‚úÖ Insumo agregado correctamente<br>
                    <small>Categor√≠a: ${categoria} | Utilidad: ${margenUtilidad}% | Valor: ${formatoMoneda(parcial)}</small>`, 
                    'success');
            } catch (error) {
                showAlert('alertInsumos', 
                    `‚ùå Error al agregar insumo: ${error.message}<br>
                    <small>Verifique los datos ingresados</small>`, 
                    'error');
            }
        }

        function agregarInsumoRapido() {
            const descripcionesRapidas = [
                { cat: "Mano de Obra", desc: "Ingeniero top√≥grafo senior", unidad: "d√≠a", cantidad: 1, costo: 800 },
                { cat: "Equipos topogr√°ficos", desc: "Estaci√≥n total robotizada", unidad: "d√≠a", cantidad: 1, costo: 500 },
                { cat: "Transporte", desc: "Alquiler de veh√≠culo 4x4", unidad: "d√≠a", cantidad: 1, costo: 300 },
                { cat: "Dise√±o y Software", desc: "Plano topogr√°fico digital", unidad: "servicio", cantidad: 1, costo: 1500 }
            ];
            
            const random = descripcionesRapidas[Math.floor(Math.random() * descripcionesRapidas.length)];
            
            document.getElementById('categoria').value = random.cat;
            actualizarDescripciones();
            
            setTimeout(() => {
                document.getElementById('descripcion').value = random.desc;
                document.getElementById('unidad').value = random.unidad;
                document.getElementById('cantidad').value = random.cantidad;
                document.getElementById('costoUnitario').value = random.costo;
                document.getElementById('margenUtilidad').value = configuracion.utilidad;
                
                showAlert('alertInsumos', '‚ö° Plantilla r√°pida cargada - Revise y modifique seg√∫n necesidad', 'info');
            }, 100);
        }

        function mostrarInsumos() {
            const tbody = document.getElementById('insumosBody');
            tbody.innerHTML = '';

            if (insumos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align:center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">No hay insumos registrados</h4>
                            <p>Agregue insumos utilizando el formulario superior</p>
                        </td>
                    </tr>
                `;
                
                // Limpiar tarjetas m√≥viles si existen
                const mobileCards = document.getElementById('mobileCardList');
                if (mobileCards) {
                    mobileCards.innerHTML = `
                        <div style="text-align:center; padding: 40px 20px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">No hay insumos</h4>
                            <p style="font-size: 0.9rem;">Agregue insumos usando el formulario</p>
                        </div>
                    `;
                }
                return;
            }

            const moneda = datosGenerales.moneda || 'Soles';
            const simbolo = moneda === 'D√≥lares' ? '$' : moneda === 'Euros' ? '‚Ç¨' : 'S/.';
            
            // GENERAR TABLA PARA DESKTOP
            insumos.forEach((insumo, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <span class="badge badge-category">${insumo.categoria}</span>
                        </td>
                        <td>
                            <strong>${insumo.descripcion}</strong>
                            ${insumo.notas ? `<br><small style="color: #666; font-size: 0.85em;">${insumo.notas}</small>` : ''}
                        </td>
                        <td>${insumo.unidad}</td>
                        <td>${insumo.cantidad.toFixed(2)}</td>
                        <td>${simbolo} ${insumo.costoUnitario.toFixed(2)}</td>
                        <td>${insumo.margenUtilidad}%</td>
                        <td><strong>${simbolo} ${insumo.parcial.toFixed(2)}</strong></td>
                        <td>
                            <button class="delete-btn" onclick="eliminarInsumo(${index})" title="Eliminar">
                                <span>üóëÔ∏è</span> Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            // GENERAR TARJETAS PARA M√ìVIL
            let mobileCards = document.getElementById('mobileCardList');
            if (!mobileCards) {
                // Crear contenedor si no existe
                const tableContainer = document.querySelector('.table-container');
                mobileCards = document.createElement('div');
                mobileCards.id = 'mobileCardList';
                mobileCards.className = 'mobile-card-list';
                mobileCards.style.display = 'none';
                tableContainer.appendChild(mobileCards);
            }
            
            mobileCards.innerHTML = '';
            
            insumos.forEach((insumo, index) => {
                const card = document.createElement('div');
                card.className = 'mobile-card';
                card.innerHTML = `
                    <div class="mobile-card-header">
                        <div class="mobile-card-category">${insumo.categoria}</div>
                        <div class="mobile-card-value">${simbolo} ${insumo.parcial.toFixed(2)}</div>
                    </div>
                    <div class="mobile-card-body">
                        <h4 style="color: var(--primary-color); margin-bottom: 8px; font-size: 1rem;">
                            ${insumo.descripcion}
                        </h4>
                        ${insumo.notas ? `<p style="color: #666; font-size: 0.85rem; margin-bottom: 8px; font-style: italic;">${insumo.notas}</p>` : ''}
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Cantidad:</span>
                            <span class="mobile-card-data">${insumo.cantidad.toFixed(2)} ${insumo.unidad}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Costo Unitario:</span>
                            <span class="mobile-card-data">${simbolo} ${insumo.costoUnitario.toFixed(2)}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Utilidad:</span>
                            <span class="mobile-card-data">${insumo.margenUtilidad}%</span>
                        </div>
                    </div>
                    <div class="mobile-card-footer">
                        <button class="btn btn-danger" onclick="eliminarInsumo(${index})" style="margin: 0;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                `;
                mobileCards.appendChild(card);
            });
        }

        function eliminarInsumo(index) {
            if (confirm('¬øEst√° seguro de eliminar este insumo?\nEsta acci√≥n no se puede deshacer.')) {
                const eliminado = insumos.splice(index, 1)[0];
                mostrarInsumos();
                guardarInsumosAuto();
                actualizarEstadisticasInsumos();
                
                showAlert('alertInsumos', 
                    `‚úÖ Insumo eliminado: ${eliminado.descripcion}<br>
                    <small>Valor eliminado: ${formatoMoneda(eliminado.parcial)}</small>`, 
                    'success');
            }
        }

        function actualizarEstadisticasInsumos() {
            const totalInsumos = insumos.length;
            const categoriasUnicas = [...new Set(insumos.map(i => i.categoria))].length;
            const subtotal = insumos.reduce((sum, item) => sum + item.subtotal, 0);
            
            document.getElementById('totalInsumos').textContent = totalInsumos;
            document.getElementById('categoriasUnicas').textContent = categoriasUnicas;
            document.getElementById('subtotalInsumos').textContent = formatoMoneda(subtotal);
        }

        function formatoMoneda(valor) {
            const moneda = datosGenerales.moneda || 'Soles';
            const simbolo = moneda === 'D√≥lares' ? '$' : moneda === 'Euros' ? '‚Ç¨' : 'S/.';
            return `${simbolo} ${parseFloat(valor).toFixed(2)}`;
        }

        function limpiarFormularioInsumos() {
            document.getElementById('descripcion').innerHTML = '<option value="">Seleccione categor√≠a primero...</option>';
            document.getElementById('cantidad').value = '';
            document.getElementById('costoUnitario').value = '';
            document.getElementById('notasInsumo').value = '';
        }

        function guardarInsumosAuto() {
            try {
                const datos = {
                    insumos: insumos,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };
                localStorage.setItem('topcal_insumos_v2', JSON.stringify(datos));
            } catch (error) {
                console.error('Error al guardar insumos:', error);
            }
        }

        function guardarInsumos() {
            try {
                if (insumos.length === 0) {
                    showAlert('alertInsumos', '‚ö†Ô∏è No hay insumos para guardar', 'warning');
                    return;
                }

                const datos = {
                    insumos: insumos,
                    timestamp: new Date().toISOString(),
                    metadata: {
                        total: insumos.length,
                        categorias: [...new Set(insumos.map(i => i.categoria))].length,
                        valorTotal: insumos.reduce((sum, item) => sum + item.parcial, 0)
                    }
                };
                
                localStorage.setItem('topcal_insumos_v2', JSON.stringify(datos));
                
                showAlert('alertInsumos', 
                    `‚úÖ Lista de insumos guardada correctamente<br>
                    <small>${insumos.length} insumos | ${formatoMoneda(datos.metadata.valorTotal)}</small>`, 
                    'success');
            } catch (error) {
                showAlert('alertInsumos', 
                    `‚ùå Error al guardar: ${error.message}<br>
                    <small>Intente exportar como backup</small>`, 
                    'error');
            }
        }

        function cargarInsumos() {
            try {
                const datosStr = localStorage.getItem('topcal_insumos_v2');
                if (!datosStr) {
                    // Intentar cargar versi√≥n anterior
                    const datosViejo = localStorage.getItem('topcal_insumos');
                    if (datosViejo) {
                        insumos = JSON.parse(datosViejo);
                        // Convertir insumos antiguos a nuevo formato
                        insumos = insumos.map(insumo => ({
                            ...insumo,
                            id: insumo.id || Date.now() + Math.random(),
                            margenUtilidad: insumo.margenUtilidad || configuracion.utilidad,
                            subtotal: insumo.parcial || (insumo.cantidad * insumo.costoUnitario),
                            utilidad: 0,
                            notas: '',
                            fechaRegistro: new Date().toISOString()
                        }));
                    } else {
                        showAlert('alertInsumos', '‚ö†Ô∏è No hay insumos guardados', 'warning');
                        return;
                    }
                } else {
                    const datos = JSON.parse(datosStr);
                    insumos = datos.insumos || [];

                }

                // VERIFICAR Y CORREGIR C√ÅLCULOS AL CARGAR
                insumos.forEach(insumo => {
                    // Recalcular valores para asegurar consistencia
                    insumo.subtotal = insumo.cantidad * insumo.costoUnitario;
                    insumo.utilidad = insumo.subtotal * ((insumo.margenUtilidad || 20) / 100);
                    insumo.parcial = insumo.subtotal + insumo.utilidad;
                    
                    // Debug: mostrar insumos con m√°rgenes extra√±os
                    if (insumo.margenUtilidad > 100 || insumo.margenUtilidad < 0) {
                        console.warn(`‚ö†Ô∏è Insumo con margen inv√°lido: ${insumo.descripcion}, margen: ${insumo.margenUtilidad}%`);
                        insumo.margenUtilidad = 20; // Reset a valor por defecto
                        insumo.utilidad = insumo.subtotal * 0.20;
                        insumo.parcial = insumo.subtotal + insumo.utilidad;
                    }
                });

                mostrarInsumos();
                actualizarEstadisticasInsumos();
                
                showAlert('alertInsumos', 
                    `‚úÖ Lista de insumos cargada correctamente<br>
                    <small>${insumos.length} insumos cargados</small>`, 
                    'success');
            } catch (error) {
                showAlert('alertInsumos', 
                    `‚ùå Error al cargar: ${error.message}<br>
                    <small>Los datos pueden estar corruptos</small>`, 
                    'error');
            }
        }

        function limpiarTodo() {
            if (insumos.length === 0) {
                showAlert('alertInsumos', '‚ÑπÔ∏è No hay insumos para limpiar', 'info');
                return;
            }

            if (confirm(`¬øEst√° seguro de eliminar TODOS los insumos?\n\nTotal: ${insumos.length} insumos\nValor total: ${formatoMoneda(insumos.reduce((s, i) => s + i.parcial, 0))}\n\nEsta acci√≥n NO se puede deshacer.`)) {
                const eliminados = insumos.length;
                insumos = [];
                localStorage.removeItem('topcal_insumos_v2');
                mostrarInsumos();
                actualizarEstadisticasInsumos();
                
                showAlert('alertInsumos', 
                    `‚úÖ ${eliminados} insumos eliminados completamente<br>
                    <small>El almacenamiento local ha sido limpiado</small>`, 
                    'success');
            }
        }

        // Funci√≥n para limpiar insumos con c√°lculos incorrectos
        function limpiarInsumosConErrores() {
            if (insumos.length === 0) return;
            
            let insumosCorregidos = 0;
            let insumosEliminados = 0;
            
            // Filtrar insumos con m√°rgenes inconsistentes
            insumos = insumos.filter(insumo => {
                const margenCalculado = insumo.margenUtilidad;
                const utilidadCalculada = insumo.subtotal * (margenCalculado / 100);
                const diferencia = Math.abs(insumo.utilidad - utilidadCalculada);
                
                // Si la diferencia es mayor al 1%, hay un error
                if (diferencia > (insumo.subtotal * 0.01)) {
                    insumosEliminados++;
                    console.log(`‚ùå Eliminado insumo con error: ${insumo.descripcion}, margen: ${insumo.margenUtilidad}%`);
                    return false;
                }
                
                // Corregir c√°lculo si es necesario
                if (Math.abs(insumo.parcial - (insumo.subtotal + insumo.utilidad)) > 0.01) {
                    insumo.parcial = insumo.subtotal + insumo.utilidad;
                    insumosCorregidos++;
                    console.log(`‚úÖ Corregido c√°lculo para: ${insumo.descripcion}`);
                }
                
                return true;
            });
            
            if (insumosCorregidos > 0 || insumosEliminados > 0) {
                mostrarInsumos();
                guardarInsumosAuto();
                
                let mensaje = '';
                if (insumosEliminados > 0) {
                    mensaje += `Se eliminaron ${insumosEliminados} insumos con c√°lculos incorrectos.<br>`;
                }
                if (insumosCorregidos > 0) {
                    mensaje += `Se corrigieron ${insumosCorregidos} insumos.<br>`;
                }
                
                showAlert('alertInsumos', 
                    `üîÑ Correcci√≥n autom√°tica aplicada<br>
                    <small>${mensaje}</small>`, 
                    'info');
            }
        }

        // ========== FUNCIONES PRESUPUESTO ==========

        function actualizarInfoProyecto() {
            const infoDiv = document.getElementById('infoProyectoResumen');
            
            if (!datosGenerales || !datosGenerales.cliente) {
                infoDiv.innerHTML = '<em style="color: #999;">Complete los datos generales en la primera pesta√±a</em>';
                return;
            }

            const moneda = datosGenerales.moneda || 'Soles';
            const simbolo = moneda === 'D√≥lares' ? '$' : moneda === 'Euros' ? '‚Ç¨' : 'S/.';
            
            infoDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Cliente:</strong><br>
                        ${datosGenerales.cliente}
                    </div>
                    <div>
                        <strong>Proyecto:</strong><br>
                        ${datosGenerales.tipoProyecto || 'No especificado'}
                    </div>
                    <div>
                        <strong>Ubicaci√≥n:</strong><br>
                        ${datosGenerales.ubicacion || 'No especificado'}
                    </div>
                    <div>
                        <strong>Fecha:</strong><br>
                        ${datosGenerales.fecha || 'No especificada'}
                    </div>
                    <div>
                        <strong>Moneda:</strong><br>
                        ${moneda} (${simbolo})
                    </div>
                </div>
            `;
        }

        function generarPresupuesto() {
            try {
                if (insumos.length === 0) {
                    const resumenHTML = `
                        <div class="alert alert-warning">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 24px;">üì¶</span>
                                <div>
                                    <strong>No hay insumos registrados</strong><br>
                                    <small>Agregue insumos en la pesta√±a anterior para generar el presupuesto</small>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('resumenPresupuesto').innerHTML = resumenHTML;
                    document.getElementById('presupuestoBody').innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align:center; padding: 50px; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üí∞</div>
                                <h4 style="color: var(--primary-color);">Presupuesto no disponible</h4>
                                <p>Agregue insumos y complete los datos generales primero</p>
                            </td>
                        </tr>
                    `;
                    
                    document.getElementById('totalItems').textContent = '0';
                    document.getElementById('totalCategorias').textContent = '0';
                    document.getElementById('totalPresupuesto').textContent = '0.00';
                    
                    return;
                }

                if (!datosGenerales || !datosGenerales.cliente) {
                    showAlert('alertPresupuesto', '‚ö†Ô∏è Complete los datos generales primero', 'warning');
                    return;
                }

                const incluirIGV = document.getElementById('incluirIGV').checked;
                const incluirUtilidad = document.getElementById('incluirUtilidad').checked;
                const mostrarDesglose = document.getElementById('mostrarDesglose').checked;
                const moneda = datosGenerales.moneda || 'Soles';
                const simbolo = moneda === 'D√≥lares' ? '$' : moneda === 'Euros' ? '‚Ç¨' : 'S/.';
                const igvPorcentaje = configuracion.igv || 18;

                // Calcular subtotales por categor√≠a
                const categoriasAgrupadas = {};
                let subtotalGeneral = 0;
                let utilidadGeneral = 0;
                let subtotalSinUtilidad = 0;

                insumos.forEach(insumo => {
                    if (!categoriasAgrupadas[insumo.categoria]) {
                        categoriasAgrupadas[insumo.categoria] = {
                            items: [],
                            subtotal: 0,
                            utilidad: 0,
                            total: 0
                        };
                    }
                    
                    const subtotalItem = insumo.cantidad * insumo.costoUnitario;
                    const utilidadItem = incluirUtilidad ? subtotalItem * (insumo.margenUtilidad / 100) : 0;
                    const totalItem = subtotalItem + utilidadItem;
                    
                    categoriasAgrupadas[insumo.categoria].items.push({
                        ...insumo,
                        subtotalItem,
                        utilidadItem,
                        totalItem
                    });
                    
                    categoriasAgrupadas[insumo.categoria].subtotal += subtotalItem;
                    categoriasAgrupadas[insumo.categoria].utilidad += utilidadItem;
                    categoriasAgrupadas[insumo.categoria].total += totalItem;
                    
                    subtotalGeneral += subtotalItem;
                    utilidadGeneral += utilidadItem;
                    subtotalSinUtilidad += subtotalItem;
                });

                const subtotalConUtilidad = subtotalGeneral + utilidadGeneral;
                const igv = incluirIGV ? subtotalConUtilidad * (igvPorcentaje / 100) : 0;
                const totalGeneral = subtotalConUtilidad + igv;

                // Generar resumen ejecutivo
                const resumenHTML = `
                    <div class="summary-box">
                        <h2><span>üìä</span> Resumen Ejecutivo del Presupuesto</h2>
                        <div class="summary-grid">
                            <div class="summary-card">
                                <h4>Subtotal Insumos</h4>
                                <p>${simbolo} ${subtotalSinUtilidad.toFixed(2)}</p>
                            </div>
                            <div class="summary-card">
                                <h4>Utilidad ${incluirUtilidad ? 'Incluida' : 'No incluida'}</h4>
                                <p>${simbolo} ${utilidadGeneral.toFixed(2)}</p>
                                <small>${incluirUtilidad ? `(${((utilidadGeneral / subtotalSinUtilidad) * 100).toFixed(1)}%)` : ''}</small>
                            </div>
                            <div class="summary-card">
                                <h4>IGV (${igvPorcentaje}%)</h4>
                                <p>${simbolo} ${igv.toFixed(2)}</p>
                                <small>${incluirIGV ? '‚úÖ Incluido' : '‚ùå No incluido'}</small>
                            </div>
                            <div class="summary-card">
                                <h4>TOTAL GENERAL</h4>
                                <p style="font-size: 2.5rem; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                                    ${simbolo} ${totalGeneral.toFixed(2)}
                                </p>
                            </div>
                        </div>
                        <div style="margin-top: 25px; font-size: 0.9em; opacity: 0.9; text-align: center;">
                            <div style="display: inline-flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                                <span><strong>Moneda:</strong> ${moneda}</span>
                                <span><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}</span>
                                <span><strong>N¬∫ de √≠tems:</strong> ${insumos.length}</span>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('resumenPresupuesto').innerHTML = resumenHTML;
                
                // Mostrar tabla de presupuesto
                mostrarPresupuestoDetallado(categoriasAgrupadas, {
                    incluirIGV,
                    incluirUtilidad,
                    mostrarDesglose,
                    moneda,
                    simbolo,
                    igvPorcentaje,
                    subtotalSinUtilidad,
                    utilidadGeneral,
                    subtotalConUtilidad,
                    igv,
                    totalGeneral
                });
                
                // Actualizar estad√≠sticas
                document.getElementById('totalItems').textContent = insumos.length;
                document.getElementById('totalCategorias').textContent = Object.keys(categoriasAgrupadas).length;
                document.getElementById('totalPresupuesto').textContent = simbolo + ' ' + totalGeneral.toFixed(2);
                
                showAlert('alertPresupuesto', 
                    `‚úÖ Presupuesto generado correctamente<br>
                    <small>Total: ${simbolo} ${totalGeneral.toFixed(2)} | ${insumos.length} √≠tems</small>`, 
                    'success');
                    
            } catch (error) {
                showAlert('alertPresupuesto', 
                    `‚ùå Error al generar presupuesto:<br>
                    ${error.message}<br>
                    <small>Verifique los datos ingresados</small>`, 
                    'error');
            }
        }

        function mostrarPresupuestoDetallado(categoriasAgrupadas, datos) {
            const tbody = document.getElementById('presupuestoBody');
            let html = '';
            
            Object.keys(categoriasAgrupadas).forEach(categoria => {
                const catData = categoriasAgrupadas[categoria];
                
                // Encabezado de categor√≠a
                html += `
                    <tr class="categoria-header">
                        <td colspan="7" style="padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 18px;">üìÅ</span>
                                    <strong style="font-size: 16px;">${categoria}</strong>
                                    <span style="font-size: 12px; background: rgba(255,107,53,0.1); color: var(--accent-color); padding: 2px 8px; border-radius: 10px;">
                                        ${catData.items.length} √≠tems
                                    </span>
                                </div>
                                <div style="font-weight: bold; color: var(--primary-color);">
                                    ${datos.simbolo} ${catData.total.toFixed(2)}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // √çtems de la categor√≠a
                catData.items.forEach((item, index) => {
                    html += `
                        <tr>
                            <td style="padding-left: 40px;">${index + 1}</td>
                            <td style="padding-left: 40px;">
                                ${item.descripcion}
                                ${item.notas ? `<br><small style="color: #666; font-size: 0.85em;"><em>${item.notas}</em></small>` : ''}
                            </td>
                            <td>${item.unidad}</td>
                            <td>${item.cantidad.toFixed(2)}</td>
                            <td>${datos.simbolo} ${item.costoUnitario.toFixed(2)}</td>
                            <td>${datos.simbolo} ${item.subtotalItem.toFixed(2)}</td>
                            <td>
                                <strong>${datos.simbolo} ${item.totalItem.toFixed(2)}</strong>
                                ${datos.incluirUtilidad ? `<br><small style="color: #28a745; font-size: 0.85em;">Utilidad: ${datos.simbolo} ${item.utilidadItem.toFixed(2)} (${item.margenUtilidad}%)</small>` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                // Subtotales por categor√≠a
                if (datos.mostrarDesglose) {
                    html += `
                        <tr style="background: rgba(0,0,0,0.02);">
                            <td colspan="5" style="text-align: right; padding: 10px 40px; font-weight: bold;">
                                Subtotal ${categoria}:
                            </td>
                            <td style="padding: 10px; font-weight: bold;">
                                ${datos.simbolo} ${catData.subtotal.toFixed(2)}
                            </td>
                            <td style="padding: 10px; font-weight: bold; color: var(--success-color);">
                                ${datos.simbolo} ${catData.total.toFixed(2)}
                            </td>
                        </tr>
                    `;
                }
            });
            
            // Totales generales
            html += `
                <tr style="background: var(--light-bg); border-top: 2px solid var(--gray-border);">
                    <td colspan="5" style="text-align: right; padding: 15px; font-weight: bold;">
                        SUBTOTAL INSUMOS:
                    </td>
                    <td style="padding: 15px; font-weight: bold;">
                        ${datos.simbolo} ${datos.subtotalSinUtilidad.toFixed(2)}
                    </td>
                    <td></td>
                </tr>
            `;
            
            if (datos.incluirUtilidad) {
                const porcentajeUtilidad = datos.subtotalSinUtilidad > 0 ? 
                    ((datos.utilidadGeneral / datos.subtotalSinUtilidad) * 100).toFixed(1) : '0.0';
                
                html += `
                    <tr style="background: var(--light-bg);">
                        <td colspan="5" style="text-align: right; padding: 15px; font-weight: bold;">
                            MARGEN DE UTILIDAD (${porcentajeUtilidad}%):
                        </td>
                        <td colspan="2" style="padding: 15px; font-weight: bold; color: var(--success-color);">
                            ${datos.simbolo} ${datos.utilidadGeneral.toFixed(2)}
                        </td>
                    </tr>
                `;
            }
            
            html += `
                <tr style="background: var(--light-bg);">
                    <td colspan="5" style="text-align: right; padding: 15px; font-weight: bold;">
                        SUBTOTAL ${datos.incluirUtilidad ? 'CON UTILIDAD' : 'SIN UTILIDAD'}:
                    </td>
                    <td colspan="2" style="padding: 15px; font-weight: bold;">
                        ${datos.simbolo} ${datos.subtotalConUtilidad.toFixed(2)}
                    </td>
                </tr>
            `;
            
            if (datos.incluirIGV) {
                html += `
                    <tr style="background: var(--light-bg);">
                        <td colspan="5" style="text-align: right; padding: 15px; font-weight: bold;">
                            IGV (${datos.igvPorcentaje}%):
                        </td>
                        <td colspan="2" style="padding: 15px; font-weight: bold; color: var(--warning-color);">
                            ${datos.simbolo} ${datos.igv.toFixed(2)}
                        </td>
                    </tr>
                `;
            }
            
            html += `
                <tr style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white;">
                    <td colspan="5" style="text-align: right; padding: 20px; font-weight: bold; font-size: 18px;">
                        TOTAL GENERAL:
                    </td>
                    <td colspan="2" style="padding: 20px; font-weight: bold; font-size: 18px;">
                        ${datos.simbolo} ${datos.totalGeneral.toFixed(2)}
                    </td>
                </tr>
            `;
            
            tbody.innerHTML = html;
        }

        // ========== FUNCIONES EXPORTACI√ìN PDF ==========

        async function exportarPDF() {
            try {
                if (insumos.length === 0) {
                    showAlert('alertPresupuesto', '‚ö†Ô∏è No hay insumos para exportar. Agregue insumos primero.', 'warning');
                    return;
                }

                if (!datosGenerales || !datosGenerales.cliente) {
                    showAlert('alertPresupuesto', '‚ö†Ô∏è Complete los datos generales primero.', 'warning');
                    return;
                }

                const loading = document.getElementById('loadingPDF');
                const loadingStatus = document.getElementById('loadingStatus');
                const loadingProgress = document.getElementById('loadingProgress');
                
                loading.classList.add('active');
                loadingStatus.textContent = 'Iniciando generaci√≥n de PDF profesional...';
                loadingProgress.style.width = '5%';

                await new Promise(resolve => setTimeout(resolve, 300));

                // ========== AGREGAR AQU√ç LA FUNCI√ìN QR ==========
                function generarQR(url) {
                    // Usar qrcode de la librer√≠a global
                    const qr = qrcode(0, 'M');  // 0 = error correction level, 'M' = Medium
                    qr.addData(url);
                    qr.make();
                    
                    // Crear imagen del QR
                    const qrImage = qr.createDataURL(10, 0);  // 10 = cell size, 0 = margin
                    return qrImage;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                
                // M√ÅRGENES
                const margin = {
                    left: 10,  // Reducido para m√°s espacio
                    right: 10,
                    top: 15,
                    bottom: 20
                };
                
                const contentWidth = pageWidth - margin.left - margin.right;
                let yPos = margin.top;

                // PALETA DE COLORES
                const colores = {
                    primario: [0, 51, 102],        // Azul #003366
                    secundario: [0, 80, 158],      // Azul #00509E
                    acento: [255, 107, 53],        // Naranja #FF6B35
                    fondo: [248, 249, 250],        // Gris claro
                    texto: [51, 51, 51],           // Gris oscuro
                    textoClaro: [102, 102, 102],   // Gris medio
                    blanco: [255, 255, 255],
                    borde: [221, 221, 221]         // Gris claro
                };

                // Configuraci√≥n
                const incluirIGV = document.getElementById('incluirIGV').checked;
                const incluirUtilidad = document.getElementById('incluirUtilidad').checked;
                const moneda = datosGenerales.moneda || 'Soles';
                const simbolo = moneda === 'D√≥lares' ? '$' : moneda === 'Euros' ? '‚Ç¨' : 'S/.';
                const igvPorcentaje = configuracion.igv || 18;
                const hoy = new Date();
                
                // Generar n√∫mero de cotizaci√≥n
                const numeroCotizacion = `TC-${hoy.getFullYear()}${String(hoy.getMonth() + 1).padStart(2, '0')}${String(hoy.getDate()).padStart(2, '0')}-${String(Math.floor(Math.random() * 9000) + 1000)}`;
                
                // URLs para QR y enlace directo
                const pdfUrlOnline = `https://drive.google.com/file/d/1KjFjJNM9u-F3uTcJN_Xw6Zpkzo8B-z3T/view?usp=sharing${numeroCotizacion}`;
                const sitioWeb = "https://topcalpro.com"; // URL del sitio web

                loadingStatus.textContent = 'Calculando an√°lisis financiero...';
                loadingProgress.style.width = '15%';

                // ========== C√ÅLCULOS ==========
                let subtotal = 0;
                let utilidad = 0;
                const categoriasAgrupadas = {};
                const estadisticasCategoria = {};
                const detalleCompleto = []; // Para el detalle completo de insumos
                
                insumos.forEach(insumo => {
                    const subtotalItem = insumo.cantidad * insumo.costoUnitario;
                    const utilidadItem = incluirUtilidad ? subtotalItem * (insumo.margenUtilidad / 100) : 0;
                    const totalItem = subtotalItem + utilidadItem;
                    
                    subtotal += subtotalItem;
                    utilidad += utilidadItem;
                    
                    if (!categoriasAgrupadas[insumo.categoria]) {
                        categoriasAgrupadas[insumo.categoria] = [];
                        estadisticasCategoria[insumo.categoria] = {
                            subtotal: 0,
                            utilidad: 0,
                            total: 0,
                            items: 0,
                            cantidadTotal: 0
                        };
                    }
                    
                    categoriasAgrupadas[insumo.categoria].push({
                        ...insumo,
                        subtotalItem,
                        utilidadItem,
                        totalItem
                    });
                    
                    estadisticasCategoria[insumo.categoria].subtotal += subtotalItem;
                    estadisticasCategoria[insumo.categoria].utilidad += utilidadItem;
                    estadisticasCategoria[insumo.categoria].total += totalItem;
                    estadisticasCategoria[insumo.categoria].items++;
                    estadisticasCategoria[insumo.categoria].cantidadTotal += insumo.cantidad;
                    
                    // Agregar al detalle completo
                    detalleCompleto.push({
                        categoria: insumo.categoria,
                        descripcion: insumo.descripcion || insumo.nombre,
                        unidad: insumo.unidad,
                        cantidad: insumo.cantidad,
                        costoUnitario: insumo.costoUnitario,
                        subtotalItem,
                        utilidadItem,
                        totalItem
                    });
                });
                
                const subtotalConUtilidad = subtotal + utilidad;
                const igv = incluirIGV ? subtotalConUtilidad * (igvPorcentaje / 100) : 0;
                const total = subtotalConUtilidad + igv;
                const porcentajeUtilidad = subtotal > 0 ? ((utilidad / subtotal) * 100).toFixed(1) : '0.0';

                // ========== FUNCIONES AUXILIARES ==========
                function agregarLogo(doc, x, y, ancho, alto) {
                    try {
                        // Intentar cargar logo desde la ruta
                        if (logoRuta) {
                            doc.addImage(logoRuta, 'JPEG', x, y, ancho, alto);
                        } else {
                            // Fallback: logo con iniciales si no hay imagen
                            doc.setFillColor(...colores.acento);
                            doc.roundedRect(x, y, ancho, alto, 5, 5, 'F');
                            
                            doc.setTextColor(...colores.blanco);
                            doc.setFontSize(ancho * 0.6);
                            doc.setFont('helvetica', 'bold');
                            doc.text('TC', x + ancho/2, y + alto/2 + 2, { align: 'center' });
                        }
                    } catch (error) {
                        console.error('Error al cargar logo:', error);
                        // Fallback: logo con iniciales
                        doc.setFillColor(...colores.acento);
                        doc.roundedRect(x, y, ancho, alto, 5, 5, 'F');
                        
                        doc.setTextColor(...colores.blanco);
                        doc.setFontSize(ancho * 0.6);
                        doc.setFont('helvetica', 'bold');
                        doc.text('TC', x + ancho/2, y + alto/2 + 2, { align: 'center' });
                    }
                }

                function agregarPiePagina(doc, numeroPagina, totalPaginas) {
                    const y = pageHeight - margin.bottom;
                    
                    doc.setDrawColor(...colores.borde);
                    doc.setLineWidth(0.5);
                    doc.line(margin.left, y - 5, pageWidth - margin.right, y - 5);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...colores.textoClaro);
                    doc.setFont('helvetica', 'italic');
                    
                    doc.text('Powered by Lithman Morales', margin.left, y);
                    doc.text(`P√°gina ${numeroPagina} de ${totalPaginas}`, pageWidth - margin.right, y, { align: 'right' });
                }

                function crearCuadroTitulo(doc, titulo, x, y, ancho, alto) {
                    doc.setFillColor(...colores.primario);
                    doc.roundedRect(x, y, ancho, alto, 3, 3, 'F');
                    
                    doc.setTextColor(...colores.blanco);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(titulo, x + 10, y + 7);
                    
                    return y + alto + 5;
                }

                function crearTarjetaDatos(doc, x, y, ancho, alto) {
                    doc.setFillColor(...colores.blanco);
                    doc.roundedRect(x, y, ancho, alto, 3, 3, 'F');
                    
                    doc.setDrawColor(...colores.borde);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(x, y, ancho, alto, 3, 3, 'S');
                    
                    return y + 10;
                }

                // ========== P√ÅGINA 1: PORTADA Y DATOS GENERALES ==========
                
                // Logo en esquina superior izquierda
                agregarLogo(doc, margin.left, margin.top, 25, 25);
                
                // T√≠tulo de la empresa
                doc.setTextColor(...colores.primario);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('TOPCAL', margin.left + 30, margin.top + 12);
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.textoClaro);
                doc.text('Servicios de Topograf√≠a y Geodesia', margin.left + 30, margin.top + 18);
                
                // L√≠nea separadora
                doc.setDrawColor(...colores.acento);
                doc.setLineWidth(1);
                doc.line(margin.left + 30, margin.top + 22, margin.left + 120, margin.top + 22);
                
                // Informaci√≥n de contacto en esquina superior derecha
                // Informaci√≥n de contacto FIJA en esquina superior derecha
                const infoContactoX = pageWidth - margin.right - 48;
                let infoContactoY = margin.top;
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colores.primario);
                
                // AQU√ç CAMBIAS EL NOMBRE DE TU EMPRESA ‚Üì
                doc.text('Lithman Adolfo Morales Rivera', infoContactoX, infoContactoY);
                infoContactoY += 5;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(...colores.textoClaro);
                
                // AQU√ç CAMBIAS TU TEL√âFONO ‚Üì
                doc.text('Tel: +51 917 524 248', infoContactoX, infoContactoY);
                infoContactoY += 4;
                
                // AQU√ç CAMBIAS TU EMAIL ‚Üì
                doc.text('lithmanmr1011@gmail.com', infoContactoX, infoContactoY);
                infoContactoY += 4;
                
                // AQU√ç CAMBIAS TU DIRECCI√ìN L√çNEA 1 ‚Üì
                doc.text('Ayacucho - Huamanga', infoContactoX, infoContactoY);
                infoContactoY += 4;
                
                // AQU√ç CAMBIAS TU DIRECCI√ìN L√çNEA 2 ‚Üì
                doc.text('Lima, Per√∫', infoContactoX, infoContactoY);
                infoContactoY += 4;
                
                // AQU√ç CAMBIAS TU P√ÅGINA WEB ‚Üì
                doc.setTextColor(...colores.acento);
                doc.text('www.topcalpro.com', infoContactoX, infoContactoY);
                
                // T√≠tulo principal con c√≥digo
                yPos = margin.top + 40;
                doc.setTextColor(...colores.primario);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('COTIZACI√ìN T√âCNICA', pageWidth / 2, yPos, { align: 'center' });
                
                // C√≥digo de cotizaci√≥n AL LADO del t√≠tulo
                yPos += 1;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.acento);
                doc.text(numeroCotizacion, pageWidth / 2, yPos + 5, { align: 'center' });
                
                yPos += 12;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.secundario);
                doc.text('Servicios Generales de Topograf√≠a y Geodesia', pageWidth / 2, yPos, { align: 'center' });
                
                // QR CODE REDUCIDO
                yPos += 15;
                const qrSize = 30; // M√°s peque√±o
                const qrX = pageWidth / 2 - qrSize / 2;
                const qrY = yPos;
                
                // Cuadro para QR m√°s compacto
                doc.setFillColor(...colores.fondo);
                doc.roundedRect(qrX - 5, qrY - 5, qrSize + 10, qrSize + 20, 5, 5, 'F');
                
                doc.setDrawColor(...colores.acento);
                doc.setLineWidth(1);
                doc.roundedRect(qrX - 5, qrY - 5, qrSize + 10, qrSize + 20, 5, 5, 'S');
                
                // ========== GENERAR QR REAL ==========
                try {
                    const qrImageData = generarQR(pdfUrlOnline);
                    doc.addImage(qrImageData, 'PNG', qrX, qrY, qrSize, qrSize);
                    console.log('‚úÖ QR generado correctamente');
                } catch (error) {
                    console.error('‚ùå Error al generar QR:', error);
                    doc.setFillColor(...colores.primario);
                    doc.roundedRect(qrX, qrY, qrSize, qrSize, 3, 3, 'F');
                    doc.setTextColor(...colores.blanco);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('QR', qrX + qrSize/2, qrY + qrSize/2 + 3, { align: 'center' });
                }
                
                // Textos debajo del QR COMPACTOS
                yPos += qrSize + 8;
                doc.setFontSize(7); // M√°s peque√±o
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.textoClaro);
                doc.text('Escanee para ver versi√≥n digital', pageWidth / 2, yPos, { align: 'center' });
                
                // URL m√°s compacta
                const urlCorto = pdfUrlOnline.length > 35 ? pdfUrlOnline.substring(0, 33) + '...' : pdfUrlOnline;
                doc.text(urlCorto, pageWidth / 2, yPos + 3, { align: 'center' });
                
                // ENLACE CLICKABLE DEBAJO DEL QR COMPACTO
                yPos += 9;
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colores.acento);
                doc.text('Visite nuestro sitio web:', pageWidth / 2, yPos, { align: 'center' });
                
                // Hacer el enlace clickable
                doc.setFontSize(7);
                doc.setTextColor(...colores.primario);
                doc.textWithLink(sitioWeb, pageWidth / 2, yPos + 4, { 
                    align: 'center',
                    url: sitioWeb 
                });
                
                // DATOS GENERALES EN VERTICAL (M√ÅS ARRIBA Y COMPACTO)
                yPos += 12; // Menos espacio
                yPos = crearCuadroTitulo(doc, 'DATOS GENERALES DEL PROYECTO', margin.left, yPos, contentWidth, 12);
                
                // Cuadro de datos generales EN UNA SOLA COLUMNA
                const datosY = crearTarjetaDatos(doc, margin.left, yPos, contentWidth, 100); // M√°s compacto
                let datosActualY = datosY;
                
                doc.setFontSize(9); // M√°s peque√±o
                
                // Lista de datos en VERTICAL CON CAMBIOS SOLICITADOS
                const datosVerticales = [
                    { label: 'Cliente/Raz√≥n Social:', value: datosGenerales.cliente || 'No especificado' },
                    { label: 'Fecha:', value: datosGenerales.fecha || hoy.toLocaleDateString('es-ES') },
                    { label: 'Tipo de Proyecto:', value: datosGenerales.tipoProyecto || 'No especificado' }, // CAMBIADO
                    { label: 'Plazo:', value: (datosGenerales.plazo || 'No especificado') + (datosGenerales.plazoUnidad ? ' ' + datosGenerales.plazoUnidad : ' d√≠as') },
                    { label: 'Ubicaci√≥n:', value: datosGenerales.ubicacion || 'No especificado' },
                    { label: 'Moneda:', value: moneda },
                    { label: 'Descripci√≥n del Proyecto:', value: datosGenerales.descripcionTrabajo || 'No especificado' }, // CAMBIADO
                    { label: 'Email:', value: datosGenerales.email || 'No especificado' },
                    { label: 'Dimensiones (Metrado):', value: datosGenerales.metrado || 'No especificado' }, // M√°s corto
                    { label: 'Tel√©fono:', value: datosGenerales.telefono || 'No especificado' }
                ];
                
                // Mostrar datos en VERTICAL compacto
                datosVerticales.forEach((dato) => {
                    // Label
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...colores.primario);
                    
                    // Label m√°s corto si es necesario
                    let labelCorto;
                    if (dato.label === 'Descripci√≥n del Proyecto:') {
                        labelCorto = dato.label; // COMPLETO
                    } else {
                        labelCorto = dato.label.length > 22 ? dato.label.substring(0, 20) + '...' : dato.label;
                    }
                    doc.text(labelCorto, margin.left + 8, datosActualY);
                    
                    // Valor
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...colores.texto);
                    
                    // Manejar valores largos
                    let valorTexto = dato.value.toString();
                    const maxAncho = contentWidth - 65; // Menos espacio para valores
                    
                    // Para descripciones y emails largos
                    if (dato.label === 'Descripci√≥n del Proyecto:' || dato.label === 'Email:') {
                        const lineas = doc.splitTextToSize(valorTexto, maxAncho);
                        lineas.forEach((linea, index) => {
                            if (index === 0) {
                                doc.text(linea, margin.left + 50, datosActualY);
                            } else {
                                datosActualY += 4;
                                doc.text(linea, margin.left + 8, datosActualY);
                            }
                        });
                    } else {
                        const lineas = doc.splitTextToSize(valorTexto, maxAncho);
                        doc.text(lineas[0], margin.left + 50, datosActualY);
                        // Si hay m√°s l√≠neas, continuar
                        if (lineas.length > 1) {
                            for (let i = 1; i < lineas.length; i++) {
                                datosActualY += 4;
                                doc.text(lineas[i], margin.left + 8, datosActualY);
                            }
                        }
                    }
                    
                    datosActualY += 7; // Espacio reducido
                });
                
                // Fecha de generaci√≥n
                yPos = datosY + 105; // Ajustado
                doc.setFontSize(7);
                doc.setTextColor(...colores.textoClaro);
                doc.setFont('helvetica', 'italic');
                const fechaGeneracion = `Documento generado el: ${hoy.toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                })}`;
                doc.text(fechaGeneracion, pageWidth / 2, yPos, { align: 'center' });
                
                // Pie de p√°gina
                agregarPiePagina(doc, 1, 5);

                loadingStatus.textContent = 'Generando distribuci√≥n de costos...';
                loadingProgress.style.width = '50%';

                // ========== P√ÅGINA 2: DISTRIBUCI√ìN DE COSTOS Y DETALLE ==========
                // ========== P√ÅGINA 2: DISTRIBUCI√ìN DE COSTOS Y DETALLE ==========
                doc.addPage();
                yPos = margin.top;

                // Logo y encabezado
                agregarLogo(doc, margin.left, yPos, 20, 20);

                doc.setTextColor(...colores.primario);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('DISTRIBUCI√ìN DE COSTOS', margin.left + 25, yPos + 12);

                doc.setFontSize(10);
                doc.setTextColor(...colores.textoClaro);
                doc.text(`C√≥digo: ${numeroCotizacion}`, pageWidth - margin.right, yPos + 12, { align: 'right' });

                yPos += 25;

                // T√≠tulo de distribuci√≥n (CON M√ÅS CARACTERES)
                yPos = crearCuadroTitulo(doc, 'DISTRIBUCI√ìN DE COSTOS POR CATEGOR√çA DE INSUMOS', margin.left, yPos, contentWidth, 12);

                // Cuadro para gr√°fico
                const graficoY = crearTarjetaDatos(doc, margin.left, yPos, contentWidth, 110);

                // Preparar datos para el gr√°fico
                const categorias = Object.keys(estadisticasCategoria);
                const valores = categorias.map(cat => estadisticasCategoria[cat].total);
                const maxValor = Math.max(...valores, 1);
                const totalCategorias = valores.reduce((a, b) => a + b, 0);

                // Dibujar gr√°fico de barras horizontal COMPACTO
                let barY = graficoY;

                // T√≠tulo del gr√°fico
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colores.primario);
                doc.text('COSTO TOTAL POR CATEGOR√çA', pageWidth / 2, barY - 5, { align: 'center' });
                barY += 5;

                // Etiquetas m√°s compactas
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.textoClaro);

                // ESCALA COMPACTA
                const anchoMaxDisponible = 80;
                const espacioEntreBarras = 8;

                // Eje X compacto
                const escalaInicioX = margin.left + 70;
                const escalaFinX = escalaInicioX + anchoMaxDisponible;

                // Escala con s√≠mbolo monetario
                doc.text(`${simbolo} 0`, escalaInicioX, barY);
                doc.text(`${simbolo} ${maxValor.toFixed(0)}`, escalaFinX, barY, { align: 'right' });

                barY += 6;

                // Dibujar barras COMPACTAS con categor√≠as de m√°ximo 25 letras (AUMENTADO)
                categorias.forEach((categoria, index) => {
                    const valor = estadisticasCategoria[categoria].total;
                    const porcentaje = totalCategorias > 0 ? ((valor / totalCategorias) * 100).toFixed(1) : 0;
                    
                    // Barra
                    const anchoBarra = Math.min((valor / maxValor) * anchoMaxDisponible, anchoMaxDisponible);
                    
                    // Nombre de categor√≠a m√°ximo 25 letras (AUMENTADO DE 15 A 25)
                    const nombreCorto = categoria.length > 25 ? categoria.substring(0, 23) + '...' : categoria;
                    doc.setTextColor(...colores.texto);
                    doc.text(nombreCorto, margin.left + 8, barY + 3);
                    
                    // Barra de color
                    const colorBarra = [
                        [41, 128, 185],   // Azul
                        [46, 204, 113],   // Verde
                        [155, 89, 182],   // P√∫rpura
                        [230, 126, 34],   // Naranja
                        [231, 76, 60],    // Rojo
                        [26, 188, 156],   // Turquesa
                        [241, 196, 15]    // Amarillo
                    ][index % 7];
                    
                    doc.setFillColor(...colorBarra);
                    doc.roundedRect(escalaInicioX, barY, anchoBarra, 5, 1, 1, 'F');
                    
                    // Valor y porcentaje COMPACTOS (en una l√≠nea)
                    const textoCompacto = `${simbolo}${valor.toFixed(0)} (${porcentaje}%)`;
                    
                    // Posici√≥n fija a la derecha del gr√°fico
                    doc.setTextColor(...colores.textoClaro);
                    doc.text(textoCompacto, pageWidth - margin.right - 5, barY + 3, { align: 'right' });
                    
                    barY += espacioEntreBarras;
                });

                // Leyenda
                barY += 5;
                doc.setFontSize(7);
                doc.setTextColor(...colores.textoClaro);
                doc.text('Cada barra representa el costo total de insumos por categor√≠a', 
                        margin.left + 8, barY);

                // DETALLE DE INSUMOS POR CATEGOR√çA CON NUEVO ORDEN COMPACTO
                yPos = graficoY + 115;
                yPos = crearCuadroTitulo(doc, 'DETALLE COMPLETO DE INSUMOS POR CATEGOR√çA', margin.left, yPos, contentWidth, 12);

                // Crear tabla con NUEVO ORDEN COMPACTO y MEJOR ALINEACI√ìN
                const crearTablaDetalle = () => {
                    const headerY = yPos;
                    
                    // Encabezado de tabla que OCUPE TODO EL ANCHO
                    doc.setFillColor(...colores.primario);
                    doc.roundedRect(margin.left, headerY, contentWidth, 10, 2, 2, 'F');
                    
                    doc.setTextColor(...colores.blanco);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    
                    // COLUMNAS CON NOMBRES ABREVIADOS COMO SOLICITAS
                    const columnas = [
                        { nombre: 'CATEG.', ancho: 35, alineacion: 'left' },
                        { nombre: 'DESCRIP.', ancho: 55, alineacion: 'left' },
                        { nombre: 'UNIDAD', ancho: 20, alineacion: 'center' },
                        { nombre: 'CANT.', ancho: 20, alineacion: 'center' },
                        { nombre: 'C/U', ancho: 28, alineacion: 'right' },
                        { nombre: 'PARCIAL', ancho: 28, alineacion: 'right' }
                    ];
                    
                    let xPos = margin.left;
                    columnas.forEach(col => {
                        const centroX = xPos + (col.ancho / 2);
                        doc.text(col.nombre, centroX, headerY + 7, { align: col.alineacion });
                        xPos += col.ancho;
                    });
                    
                    // Datos con M√ÅS CARACTERES PARA DESCRIPCI√ìN
                    let filaY = headerY + 12;
                    let totalParcial = 0;
                    let currentCategoria = '';
                    
                    detalleCompleto.forEach((item, index) => {
                        // ========== VERIFICAR ESPACIO ANTES DE DIBUJAR FILA ==========
                        const espacioRestante = pageHeight - filaY - margin.bottom;
                        const espacioNecesarioFila = 15; // Espacio para una fila completa
                        
                        // Si no hay espacio suficiente, crear nueva p√°gina
                        if (espacioRestante < espacioNecesarioFila) {
                            // Agregar pie de p√°gina antes de cambiar
                            agregarPiePagina(doc, 2, 5);
                            
                            // Nueva p√°gina
                            doc.addPage();
                            filaY = margin.top + 20; // M√°s espacio arriba
                            
                            // ========== RECREAR ENCABEZADO CON M√ÅS ESPACIO ==========
                            doc.setFillColor(...colores.primario);
                            doc.roundedRect(margin.left, filaY - 12, contentWidth, 10, 2, 2, 'F');
                            
                            doc.setTextColor(...colores.blanco);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            
                            let xPos2 = margin.left;
                            columnas.forEach(col => {
                                const centroX = xPos2 + (col.ancho / 2);
                                doc.text(col.nombre, centroX, filaY - 5, { align: col.alineacion });
                                xPos2 += col.ancho;
                            });
                            
                            filaY += 5; // ‚¨ÖÔ∏è ESPACIO ENTRE ENCABEZADO Y CONTENIDO
                        }
                        
                        // Fondo alternado
                        if (index % 2 === 0) {
                            doc.setFillColor(...colores.fondo);
                            doc.rect(margin.left, filaY - 3, contentWidth, 9, 'F');
                        }
                        
                        // Datos
                        xPos = margin.left;
                        
                        // CATEG. (m√°ximo 20 letras)
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...colores.texto);
                        
                        if (item.categoria !== currentCategoria) {
                            currentCategoria = item.categoria;
                            const catCorto = item.categoria.length > 20 ? item.categoria.substring(0, 18) + '..' : item.categoria;
                            doc.text(catCorto, xPos + 5, filaY);
                        } else {
                            doc.text('', xPos + 5, filaY);
                        }
                        xPos += columnas[0].ancho;
                        
                        // DESCRIP. (m√°ximo 30 letras)
                        const descCorta = item.descripcion.length > 30 ? item.descripcion.substring(0, 28) + '..' : item.descripcion;
                        doc.text(descCorta, xPos + 5, filaY);
                        xPos += columnas[1].ancho;
                        
                        // UNIDAD
                        const unidadText = item.unidad || '-';
                        const unidadCorta = unidadText.length > 6 ? unidadText.substring(0, 4) + '..' : unidadText;
                        doc.text(unidadCorta, xPos + (columnas[2].ancho / 2), filaY, { align: 'center' });
                        xPos += columnas[2].ancho;
                        
                        // CANT.
                        doc.text(item.cantidad.toFixed(2), xPos + (columnas[3].ancho / 2), filaY, { align: 'center' });
                        xPos += columnas[3].ancho;
                        
                        // C/U
                        doc.text(`${simbolo} ${item.costoUnitario.toFixed(2)}`, 
                                xPos + columnas[4].ancho - 5, filaY, { align: 'right' });
                        xPos += columnas[4].ancho;
                        
                        // PARCIAL
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...colores.primario);
                        doc.text(`${simbolo} ${item.subtotalItem.toFixed(2)}`, 
                                xPos + columnas[5].ancho - 5, filaY, { align: 'right' });
                        
                        totalParcial += item.subtotalItem;
                        
                        filaY += 9; // Siguiente fila
                    });
                    
                    return filaY + 10;
                };

                crearTablaDetalle();

                // Pie de p√°gina
                agregarPiePagina(doc, 2, 5);

                loadingStatus.textContent = 'Generando firmas y aprobaci√≥n...';
                loadingProgress.style.width = '85%';

                // ========== P√ÅGINA 3: RESUMEN FINANCIERO Y CONDICIONES ==========
                doc.addPage();
                yPos = margin.top;
                
                // Logo y encabezado
                agregarLogo(doc, margin.left, yPos, 20, 20);
                
                doc.setTextColor(...colores.primario);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('RESUMEN FINANCIERO', margin.left + 25, yPos + 12);
                
                yPos += 25;
                
                // RESUMEN FINANCIERO COMPLETO
                yPos = crearCuadroTitulo(doc, 'RESUMEN FINANCIERO', margin.left, yPos, contentWidth, 12);
                
                const resumenY = crearTarjetaDatos(doc, margin.left, yPos, contentWidth, 80);
                let resumenActualY = resumenY;
                
                // Tabla de resumen financiero
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colores.primario);
                doc.text('CONCEPTO', margin.left + 10, resumenActualY);
                doc.text('MONTO', margin.left + contentWidth - 10, resumenActualY, { align: 'right' });
                
                resumenActualY += 8;
                doc.setDrawColor(...colores.borde);
                doc.setLineWidth(0.5);
                doc.line(margin.left + 10, resumenActualY, margin.left + contentWidth - 10, resumenActualY);
                
                resumenActualY += 8;
                
                // Subtotal
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.texto);
                doc.text('Subtotal', margin.left + 15, resumenActualY);
                doc.text(`${simbolo} ${subtotal.toFixed(2)}`, margin.left + contentWidth - 15, resumenActualY, { align: 'right' });
                resumenActualY += 10;
                
                // Utilidad
                if (incluirUtilidad) {
                    doc.text(`Utilidad (${porcentajeUtilidad}%)`, margin.left + 15, resumenActualY);
                    doc.setTextColor(...colores.acento);
                    doc.text(`${simbolo} ${utilidad.toFixed(2)}`, margin.left + contentWidth - 15, resumenActualY, { align: 'right' });
                    resumenActualY += 10;
                    doc.setTextColor(...colores.texto);
                }
                
                // Subtotal con utilidad
                doc.setFont('helvetica', 'bold');
                doc.text('Subtotal con Utilidad', margin.left + 15, resumenActualY);
                doc.text(`${simbolo} ${subtotalConUtilidad.toFixed(2)}`, margin.left + contentWidth - 15, resumenActualY, { align: 'right' });
                resumenActualY += 12;
                
                // IGV
                if (incluirIGV) {
                    doc.setFont('helvetica', 'normal');
                    doc.text(`IGV (${igvPorcentaje}%)`, margin.left + 15, resumenActualY);
                    doc.setTextColor(...colores.secundario);
                    doc.text(`${simbolo} ${igv.toFixed(2)}`, margin.left + contentWidth - 15, resumenActualY, { align: 'right' });
                    resumenActualY += 10;
                }
                
                // L√≠nea separadora
                doc.setDrawColor(...colores.acento);
                doc.setLineWidth(1);
                doc.line(margin.left + 10, resumenActualY, margin.left + contentWidth - 10, resumenActualY);
                
                resumenActualY += 8;
                
                // TOTAL
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colores.acento);
                doc.text('TOTAL GENERAL', margin.left + 15, resumenActualY);
                doc.text(`${simbolo} ${total.toFixed(2)}`, margin.left + contentWidth - 15, resumenActualY, { align: 'right' });
                
                // FIRMAS
                yPos = resumenY + 85;
                yPos = crearCuadroTitulo(doc, 'FIRMAS Y SELLOS DE RESPONSABLES', margin.left, yPos, contentWidth, 12);
                
                const firmaY = crearTarjetaDatos(doc, margin.left, yPos, contentWidth, 80);
                
                const colFirma = contentWidth / 3;
                
                // Firma del CLIENTE (izquierda)
                doc.setDrawColor(...colores.textoClaro);
                doc.setLineWidth(0.5);
                doc.line(margin.left + colFirma/2 - 25, firmaY + 30, margin.left + colFirma/2 + 25, firmaY + 30);
                
                doc.setFontSize(9);
                doc.setTextColor(...colores.texto);
                doc.setFont('helvetica', 'bold');
                doc.text('CLIENTE', margin.left + colFirma/2, firmaY + 10, { align: 'center' });
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(...colores.textoClaro);
                doc.text('Nombre y Firma', margin.left + colFirma/2, firmaY + 35, { align: 'center' });
                doc.text('DNI / RUC', margin.left + colFirma/2, firmaY + 41, { align: 'center' });
                doc.text('Fecha', margin.left + colFirma/2, firmaY + 47, { align: 'center' });
                
                // Sello de APROBACI√ìN (centro)
                const centroX = margin.left + colFirma * 1.5;
                doc.setDrawColor(...colores.acento);
                doc.setLineWidth(1.5);
                doc.circle(centroX, firmaY + 20, 15, 'S');
                
                agregarLogo(doc, centroX - 7.5, firmaY + 12.5, 15, 15);
                
                doc.setFontSize(7);
                doc.setTextColor(...colores.acento);
                doc.setFont('helvetica', 'bold');
                doc.text('APROBADO', centroX, firmaY + 40, { align: 'center' });
                doc.text(hoy.toLocaleDateString('es-ES'), centroX, firmaY + 46, { align: 'center' });
                
                // Firma del REPRESENTANTE (derecha)
                const repX = margin.left + colFirma * 2.5;
                doc.setDrawColor(...colores.textoClaro);
                doc.setLineWidth(0.5);
                doc.line(repX - 25, firmaY + 30, repX + 25, firmaY + 30);
                
                doc.setFontSize(9);
                doc.setTextColor(...colores.texto);
                doc.setFont('helvetica', 'bold');
                doc.text('TOPCAL', repX, firmaY + 10, { align: 'center' });
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(...colores.textoClaro);
                doc.text('Responsable', repX, firmaY + 35, { align: 'center' });
                doc.text('Firma y Sello', repX, firmaY + 41, { align: 'center' });
                doc.text('RUC: ' + (configuracion.ruc || '10751202135'), repX, firmaY + 47, { align: 'center' });
                
                // T√âRMINOS Y CONDICIONES SIN SOLAPAMIENTOS
                yPos = firmaY + 85;
                
                // Verificar si hay espacio suficiente
                const espacioDisponible = pageHeight - yPos - margin.bottom - 20;
                if (espacioDisponible > 50) {
                    yPos = crearCuadroTitulo(doc, 'CONDICIONES GENERALES', margin.left, yPos, contentWidth, 12);
                    
                    const terminosY = crearTarjetaDatos(doc, margin.left, yPos, contentWidth, espacioDisponible - 10);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...colores.texto);
                    doc.setFont('helvetica', 'normal');
                    
                    const condiciones = [
                        `‚Ä¢ Validez: 30 d√≠as desde ${hoy.toLocaleDateString('es-ES')}`,
                        `‚Ä¢ Pago: 50% al inicio, 50% contra entrega`,
                        `‚Ä¢ Plazo de ejecuci√≥n: ${datosGenerales.plazo || 'A coordinar'}`,
                        `‚Ä¢ Modificaciones al alcance pueden variar costo y plazo`,
                        `‚Ä¢ Los precios incluyen IGV ${igvPorcentaje}% donde aplica`,
                        `‚Ä¢ Garant√≠a de precisi√≥n seg√∫n normas t√©cnicas vigentes`,
                        `‚Ä¢ Documento v√°lido sin firma manuscrita`,
                        `‚Ä¢ Para consultas adicionales contacte a: ${configuracion.email || 'contacto@topcalpro.com'}`
                    ];
                    
                    let termY = terminosY;
                    condiciones.forEach(cond => {
                        const lineas = doc.splitTextToSize(cond, contentWidth - 20);
                        lineas.forEach((linea, i) => {
                            if (termY < pageHeight - margin.bottom - 10) {
                                doc.text(linea, margin.left + 10, termY);
                                termY += 4;
                            }
                        });
                        termY += 3; // Espacio entre items
                    });
                } else {
                    // Si no hay espacio, mostrar fecha y hora de generaci√≥n
                    doc.setFontSize(8);
                    doc.setTextColor(...colores.textoClaro);
                    doc.setFont('helvetica', 'italic');
                    
                    const fechaActual = new Date();
                    const fechaFormato = fechaActual.toLocaleDateString('es-ES', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const horaFormato = fechaActual.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    
                    doc.text(`PDF generado el ${fechaFormato} a las ${horaFormato}`, 
                            pageWidth / 2, yPos, { align: 'center' });
                }

                // Pie de p√°gina p√°gina 3
                agregarPiePagina(doc, 3, 5); // ‚Üê Cambiado a 4 p√°ginas totales

                loadingStatus.textContent = 'Generando t√©rminos y condiciones...';
                loadingProgress.style.width = '95%';

                // ========== P√ÅGINA 4: T√âRMINOS Y CONDICIONES ==========
                doc.addPage();
                yPos = margin.top;

                // Logo y encabezado
                agregarLogo(doc, margin.left, yPos, 20, 20);

                doc.setTextColor(...colores.primario);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('T√âRMINOS Y CONDICIONES', margin.left + 25, yPos + 12);

                doc.setFontSize(10);
                doc.setTextColor(...colores.textoClaro);
                doc.text(`C√≥digo: ${numeroCotizacion}`, pageWidth - margin.right, yPos + 12, { align: 'right' });

                yPos += 30;

                // T√≠tulo de secci√≥n
                yPos = crearCuadroTitulo(doc, 'CONDICIONES GENERALES DE LA COTIZACI√ìN', margin.left, yPos, contentWidth, 12);

                // Cuadro de t√©rminos
                const terminosY = crearTarjetaDatos(doc, margin.left, yPos, contentWidth, 200);
                
                doc.setFontSize(9);
                doc.setTextColor(...colores.texto);
                doc.setFont('helvetica', 'normal');
                
                const terminosCompletos = [
                    {
                        titulo: '1. VALIDEZ DE LA OFERTA',
                        contenido: `Esta cotizaci√≥n tiene una validez de 15 d√≠as calendario a partir del ${hoy.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}. Despu√©s de esta fecha, los precios y condiciones est√°n sujetos a revisi√≥n y actualizaci√≥n.`
                    },
                    {
                        titulo: '2. CONDICIONES DE PAGO',
                        contenido: `‚Ä¢ 50% al inicio de los trabajos como adelanto.\n‚Ä¢ 50% restante contra entrega de productos finales.\n‚Ä¢ Los pagos se realizar√°n mediante transferencia bancaria o dep√≥sito en cuenta.`
                    },
                    {
                        titulo: '3. PLAZO DE EJECUCI√ìN',
                        contenido: `El plazo de ejecuci√≥n estimado es de ${datosGenerales.plazo || 'seg√∫n lo acordado'}, contados a partir de la firma del contrato y recepci√≥n del adelanto. Este plazo podr√° variar seg√∫n condiciones clim√°ticas, accesibilidad al terreno o circunstancias de fuerza mayor.`
                    },
                    {
                        titulo: '4. ALCANCE DEL SERVICIO',
                        contenido: `Los servicios incluidos est√°n detallados en la secci√≥n de presupuesto. Cualquier trabajo adicional o modificaci√≥n al alcance original ser√° cotizado por separado y requerir√° aprobaci√≥n por escrito del cliente.`
                    },
                    {
                        titulo: '5. IMPUESTOS',
                        contenido: `${incluirIGV ? 'Los precios incluyen el Impuesto General a las Ventas (IGV) del ' + igvPorcentaje + '%.' : 'Los precios NO incluyen IGV. El impuesto se facturar√° por separado seg√∫n normativa vigente.'}`
                    },
                    {
                        titulo: '6. ENTREGABLES',
                        contenido: `Se entregar√°n todos los productos especificados en formato digital (archivos CAD, PDF, shapefiles, etc.) y, de ser requerido, copias f√≠sicas impresas. Los datos de campo quedan en propiedad del cliente una vez realizado el pago total.`
                    },
                    {
                        titulo: '7. RESPONSABILIDADES DEL CLIENTE',
                        contenido: `‚Ä¢ Facilitar el acceso al √°rea de trabajo.\n‚Ä¢ Proporcionar informaci√≥n previa necesaria (planos existentes, documentos legales).\n‚Ä¢ Coordinar permisos de ingreso si el proyecto lo requiere.\n‚Ä¢ Informar sobre riesgos o condiciones especiales del terreno.`
                    },
                    {
                        titulo: '8. VALIDEZ LEGAL',
                        contenido: `Este documento constituye una oferta comercial vinculante una vez aceptada por el cliente mediante firma o confirmaci√≥n escrita. Ambas partes se comprometen a cumplir con los t√©rminos aqu√≠ establecidos.`
                    }
                ];

                let termY = terminosY;
                
                terminosCompletos.forEach((seccion, index) => {
                    // Verificar si necesitamos nueva p√°gina
                    if (termY > pageHeight - margin.bottom - 40) {
                        agregarPiePagina(doc, 4, 5);
                        doc.addPage();
                        termY = margin.top + 20;
                    }
                    
                    // T√≠tulo de secci√≥n
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...colores.primario);
                    doc.setFontSize(9);
                    doc.text(seccion.titulo, margin.left + 10, termY);
                    termY += 6;
                    
                    // Contenido
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...colores.texto);
                    doc.setFontSize(8);
                    
                    const lineas = doc.splitTextToSize(seccion.contenido, contentWidth - 25);
                    lineas.forEach(linea => {
                        if (termY > pageHeight - margin.bottom - 15) {
                            agregarPiePagina(doc, 4, 4);
                            doc.addPage();
                            termY = margin.top + 20;
                        }
                        doc.text(linea, margin.left + 15, termY);
                        termY += 4;
                    });
                    
                    termY += 5; // Espacio entre secciones
                });

                // Informaci√≥n de contacto final
                // ========== P√ÅGINA 5: INFORMACI√ìN DE CONTACTO ==========
                agregarPiePagina(doc, 4, 5); // ‚Üê Cambiado a 5 p√°ginas totales
                doc.addPage();
                yPos = margin.top;

                // Logo y encabezado
                agregarLogo(doc, margin.left, yPos, 20, 20);

                doc.setTextColor(...colores.primario);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('INFORMACI√ìN DE CONTACTO', margin.left + 25, yPos + 12);

                doc.setFontSize(10);
                doc.setTextColor(...colores.textoClaro);
                doc.text(`C√≥digo: ${numeroCotizacion}`, pageWidth - margin.right, yPos + 12, { align: 'right' });

                yPos += 30;

                yPos = crearCuadroTitulo(doc, 'DATOS DE CONTACTO Y CONSULTAS', margin.left, yPos, contentWidth, 12);
                
                const contactoY = crearTarjetaDatos(doc, margin.left, yPos, contentWidth, 40);
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.texto);
                
                let contactoActualY = contactoY;
                
                doc.text('Para consultas, aclaraciones o coordinaciones adicionales:', margin.left + 10, contactoActualY);
                contactoActualY += 8;
                
                doc.setFont('helvetica', 'bold');
                doc.text('Email:', margin.left + 10, contactoActualY);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.acento);
                doc.text('lithmanmr1011@gmail.com', margin.left + 35, contactoActualY);
                contactoActualY += 5;
                
                doc.setTextColor(...colores.texto);
                doc.setFont('helvetica', 'bold');
                doc.text('Tel√©fono:', margin.left + 10, contactoActualY);
                doc.setFont('helvetica', 'normal');
                doc.text('+51 917 524 248', margin.left + 35, contactoActualY);
                contactoActualY += 5;
                
                doc.setFont('helvetica', 'bold');
                doc.text('Web:', margin.left + 10, contactoActualY);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colores.acento);
                doc.text('www.topcalpro.com', margin.left + 35, contactoActualY);

                // Pie de p√°gina final
                agregarPiePagina(doc, 5, 5); // ‚Üê P√°gina 5 de 5

                // Fecha y hora de generaci√≥n
                contactoActualY += 15;
                doc.setFontSize(7);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(...colores.textoClaro);

                loadingStatus.textContent = 'Finalizando documento...';
                loadingProgress.style.width = '100%';

                // ========== GUARDAR PDF ==========
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const nombreArchivo = `Cotizacion_${datosGenerales.cliente.replace(/[^a-z0-9]/gi, '_')}_${numeroCotizacion}.pdf`;
                
                loading.classList.remove('active');
                
                // Crear blob
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Modal de confirmaci√≥n
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.9); z-index: 10000; 
                    display: flex; align-items: center; justify-content: center;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;

                // Agregar despu√©s de appendChild(modal)
                document.body.appendChild(modal);

                // Animar entrada
                setTimeout(() => {
                    modal.style.opacity = '1';
                }, 10);
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative;">
                        
                        <!-- BOT√ìN X PARA CERRAR -->
                        <button onclick="cerrarModal('${pdfUrl}')" 
                                style="position: absolute; top: 10px; right: 10px; 
                                    background: #dc3545; color: white; border: none; 
                                    width: 35px; height: 35px; border-radius: 50%; 
                                    cursor: pointer; font-size: 20px; font-weight: bold;
                                    display: flex; align-items: center; justify-content: center;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                                onmouseover="this.style.background='#c82333'; this.style.transform='scale(1.1)';"
                                onmouseout="this.style.background='#dc3545'; this.style.transform='scale(1)';">
                            √ó
                        </button>
                        
                        <div style="color: #28a745; font-size: 48px; margin-bottom: 15px;">‚úì</div>
                        <h3 style="color: #003366; margin-bottom: 10px;">PDF Generado Correctamente</h3>
                        <p style="color: #666; margin-bottom: 8px; font-size: 14px;">
                            <strong>${nombreArchivo}</strong>
                        </p>
                        <p style="color: #999; font-size: 13px; margin-bottom: 20px;">
                            ${doc.internal.getNumberOfPages()} p√°ginas | ${insumos.length} items | Total: ${simbolo} ${total.toFixed(2)}
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="window.open('${pdfUrl}', '_blank')" 
                                    style="padding: 12px 24px; background: #003366; color: white; 
                                        border: none; border-radius: 6px; cursor: pointer; 
                                        font-weight: bold; min-width: 120px;
                                        transition: all 0.3s ease;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                üìÑ Abrir PDF
                            </button>
                            
                            <button onclick="const link = document.createElement('a'); 
                                            link.href = '${pdfUrl}'; 
                                            link.download = '${nombreArchivo}'; 
                                            link.click();" 
                                    style="padding: 12px 24px; background: #FF6B35; color: white; 
                                        border: none; border-radius: 6px; cursor: pointer; 
                                        font-weight: bold; min-width: 120px;
                                        transition: all 0.3s ease;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                üíæ Descargar
                            </button>
                            
                            <!-- ‚≠ê NUEVO BOT√ìN COMPARTIR ‚≠ê -->
                            <button id="btnCompartirPDF" 
                                    style="padding: 12px 24px; background: #28a745; color: white; 
                                        border: none; border-radius: 6px; cursor: pointer; 
                                        font-weight: bold; min-width: 120px;
                                        transition: all 0.3s ease;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                üì§ Compartir
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);

                // AGREGAR FUNCIONALIDAD AL BOT√ìN COMPARTIR
                setTimeout(() => {
                    const btnCompartir = document.getElementById('btnCompartirPDF');
                    if (btnCompartir) {
                        btnCompartir.addEventListener('click', async () => {
                            await compartirPDFMovil(pdfBlob, nombreArchivo);
                        });
                    }
                }, 100);
                
                // Auto-cerrar despu√©s de 30 segundos
                setTimeout(() => {
                    if (document.body.contains(modal)) {
                        modal.remove();
                        URL.revokeObjectURL(pdfUrl);
                    }
                }, 30000);
                
                showAlert('alertPresupuesto', `‚úÖ PDF generado: ${nombreArchivo}`, 'success');

            } catch (error) {
                document.getElementById('loadingPDF').classList.remove('active');
                showAlert('alertPresupuesto', `‚ùå Error: ${error.message}`, 'error');
                console.error('Error en PDF:', error);
            }
        }

        function generarPropuesta() {
            if (!datosGenerales || !datosGenerales.cliente) {
                showAlert('alertPresupuesto', '‚ö†Ô∏è Complete los datos generales primero', 'warning');
                return;
            }

            const propuesta = `
PROPUESTA COMERCIAL - TOPCAL PROFESSIONAL
==========================================

INFORMACI√ìN DEL CLIENTE
----------------------
‚Ä¢ Cliente: ${datosGenerales.cliente}
‚Ä¢ Proyecto: ${datosGenerales.tipoProyecto || 'No especificado'}
‚Ä¢ Ubicaci√≥n: ${datosGenerales.ubicacion || 'No especificado'}
‚Ä¢ Fecha: ${datosGenerales.fecha || 'No especificada'}
‚Ä¢ Plazo: ${datosGenerales.plazo || 'No especificado'}

NUESTRA PROPUESTA
-----------------
TopCal ofrece servicios generales de topograf√≠a. Nuestro equipo garantiza resultados precisos y confiables.

VALOR AGREGADO
--------------
‚úì Equipos de √∫ltima generaci√≥n
‚úì Personal certificado
‚úì Procesos optimizados
‚úì Garant√≠a de calidad
‚úì Soporte t√©cnico 24/7

PR√ìXIMOS PASOS
--------------
1. Confirmaci√≥n de la cotizaci√≥n
2. Firma del contrato
3. Pago inicial (50%)
4. Ejecuci√≥n del proyecto
5. Entrega de resultados
6. Pago final (50%)

CONTACTO
--------
Para m√°s informaci√≥n, no dude en contactarnos.

Atentamente,
Equipo TopCal Professional
            `;

            const blob = new Blob([propuesta], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `Propuesta_${datosGenerales.cliente.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);

            showAlert('alertPresupuesto', 
                '‚úÖ Propuesta comercial generada<br>' +
                'üìÑ Puede personalizar este documento antes de enviarlo al cliente.', 
                'success');
        }

        function compartirPresupuesto() {
            try {
                if (insumos.length === 0) {
                    showAlert('alertPresupuesto', '‚ö†Ô∏è No hay presupuesto para compartir', 'warning');
                    return;
                }

                if (!datosGenerales || !datosGenerales.cliente) {
                    showAlert('alertPresupuesto', '‚ö†Ô∏è Complete los datos generales primero', 'warning');
                    return;
                }

                const incluirIGV = document.getElementById('incluirIGV').checked;
                const incluirUtilidad = document.getElementById('incluirUtilidad').checked;
                const moneda = datosGenerales.moneda || 'Soles';
                const simbolo = moneda === 'D√≥lares' ? '$' : moneda === 'Euros' ? '‚Ç¨' : 'S/.';
                const igvPorcentaje = configuracion.igv || 18;

                let subtotal = 0;
                let utilidad = 0;
                insumos.forEach(insumo => {
                    const subtotalItem = insumo.cantidad * insumo.costoUnitario;
                    subtotal += subtotalItem;
                    utilidad += incluirUtilidad ? subtotalItem * (insumo.margenUtilidad / 100) : 0;
                });
                
                const subtotalConUtilidad = subtotal + utilidad;
                const igv = incluirIGV ? subtotalConUtilidad * (igvPorcentaje / 100) : 0;
                const total = subtotalConUtilidad + igv;
                const categoriasUnicas = [...new Set(insumos.map(i => i.categoria))];

                const resumen = `
COTIZACI√ìN TOPCAL PROFESSIONAL
${'='.repeat(50)}

DATOS DEL PROYECTO
${'-'.repeat(30)}
Cliente: ${datosGenerales.cliente}
Proyecto: ${datosGenerales.tipoProyecto || ''}
Ubicaci√≥n: ${datosGenerales.ubicacion || ''}
Fecha: ${datosGenerales.fecha || new Date().toLocaleDateString()}
Plazo: ${datosGenerales.plazo || 'No especificado'}

RESUMEN FINANCIERO
${'-'.repeat(30)}
Subtotal Insumos: ${simbolo} ${subtotal.toFixed(2)}
${incluirUtilidad ? `Margen de Utilidad: ${simbolo} ${utilidad.toFixed(2)}` : ''}
${incluirIGV ? `IGV (${igvPorcentaje}%): ${simbolo} ${igv.toFixed(2)}` : ''}
${'‚îÄ'.repeat(30)}
TOTAL GENERAL: ${simbolo} ${total.toFixed(2)}

ESTAD√çSTICAS
${'-'.repeat(30)}
‚Ä¢ √çtems totales: ${insumos.length}
‚Ä¢ Categor√≠as: ${categoriasUnicas.length}
‚Ä¢ Moneda: ${moneda} (${simbolo})

CONTACTO
${'-'.repeat(30)}
Email: ${datosGenerales.email || 'No especificado'}
Tel√©fono: ${datosGenerales.telefono || 'No especificado'}

${'='.repeat(50)}
Documento generado con TopCal Professional v3.0
Fecha: ${new Date().toLocaleString()}
¬© ${new Date().getFullYear()} TopCal Professional
                `;

                if (navigator.share && navigator.canShare) {
                    navigator.share({
                        title: `Cotizaci√≥n ${datosGenerales.cliente}`,
                        text: resumen,
                        files: []
                    }).catch(() => {
                        // Fallback a descarga
                        descargarArchivo(resumen);
                    });
                } else {
                    descargarArchivo(resumen);
                }

                function descargarArchivo(contenido) {
                    const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Resumen_Cotizacion_${datosGenerales.cliente.replace(/[^a-z0-9]/gi, '_')}.txt`;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                }

                showAlert('alertPresupuesto', 
                    '‚úÖ Presupuesto listo para compartir<br>' +
                    'üìÑ El resumen ha sido generado y est√° listo para enviar.', 
                    'success');

            } catch (error) {
                showAlert('alertPresupuesto', '‚ùå Error al compartir: ' + error.message, 'error');
            }
        }

        // ========== FUNCIONES CONFIGURACI√ìN ==========

        function guardarConfiguracion() {
            try {
                configuracion = {
                    igv: parseFloat(document.getElementById('configIGV').value) || 18,
                    utilidad: parseFloat(document.getElementById('configUtilidad').value) || 20,
                    ruc: document.getElementById('configRUC').value.trim()
                };

                // Validar que el porcentaje de utilidad sea v√°lido
                if (configuracion.utilidad < 0 || configuracion.utilidad > 100) {
                    showAlert('configAlert', '‚ùå El margen de utilidad debe estar entre 0% y 100%', 'error');
                    return;
                }

                localStorage.setItem('topcal_config_v2', JSON.stringify(configuracion));

                // Sincronizar con formulario de insumos - FORZAR ACTUALIZACI√ìN
                const margenUtilidadInput = document.getElementById('margenUtilidad');
                if (margenUtilidadInput) {
                    margenUtilidadInput.value = configuracion.utilidad;
                    console.log('‚úÖ Margen de utilidad actualizado:', configuracion.utilidad + '%');
                }

                showAlert('configAlert', 
                    `‚úÖ Configuraci√≥n guardada correctamente<br>
                    <small>IGV: ${configuracion.igv}% | Utilidad: ${configuracion.utilidad}%</small><br>
                    <small>El margen se aplicar√° a nuevos insumos</small>`, 
                    'success');
                    
                actualizarEstadisticasSistema();
                
            } catch (error) {
                showAlert('configAlert', '‚ùå Error al guardar configuraci√≥n: ' + error.message, 'error');
            }
        }

        function resetearConfiguracion() {
            if (confirm('¬øRestablecer configuraci√≥n a valores predeterminados?\nSe perder√°n los valores personalizados.')) {
                configuracion = {
                    igv: 18,
                    utilidad: 20,
                    ruc: ''
                };
                
                document.getElementById('configIGV').value = 18;
                document.getElementById('configUtilidad').value = 20;
                document.getElementById('configRUC').value = '';
                
                localStorage.removeItem('topcal_config_v2');
                
                showAlert('configAlert', '‚úÖ Configuraci√≥n restablecida a valores predeterminados', 'success');
                actualizarEstadisticasSistema();
            }
        }

        // Funci√≥n para aplicar el margen actual a todos los insumos
        function aplicarMargenActualATodos() {
            const nuevoMargen = parseFloat(document.getElementById('configUtilidad').value);
            
            if (isNaN(nuevoMargen) || nuevoMargen < 0 || nuevoMargen > 100) {
                showAlert('configAlert', '‚ùå Ingrese un margen v√°lido (0-100%)', 'error');
                return;
            }
            
            if (insumos.length === 0) {
                showAlert('configAlert', '‚ö†Ô∏è No hay insumos para actualizar', 'warning');
                return;
            }
            
            if (confirm(`¬øAplicar margen de ${nuevoMargen}% a TODOS los ${insumos.length} insumos?\n\nEsto recalcular√° todos los valores con el nuevo porcentaje.`)) {
                insumos.forEach(insumo => {
                    const subtotal = insumo.cantidad * insumo.costoUnitario;
                    const nuevaUtilidad = subtotal * (nuevoMargen / 100);
                    
                    insumo.margenUtilidad = nuevoMargen;
                    insumo.utilidad = nuevaUtilidad;
                    insumo.parcial = subtotal + nuevaUtilidad;
                });
                
                mostrarInsumos();
                guardarInsumosAuto();
                actualizarEstadisticasInsumos();
                
                showAlert('configAlert', 
                    `‚úÖ Margen de ${nuevoMargen}% aplicado a todos los insumos<br>
                    <small>${insumos.length} insumos actualizados</small>`, 
                    'success');
            }
        }

        function actualizarEstadisticasSistema() {
            const estadisticasDiv = document.getElementById('estadisticasSistema');
            
            const totalDatos = Object.keys(datosGenerales).filter(k => datosGenerales[k]).length;
            const totalInsumos = insumos.length;
            const totalCategorias = [...new Set(insumos.map(i => i.categoria))].length;
            const espacioUsado = JSON.stringify(localStorage).length;
            const espacioKB = (espacioUsado / 1024).toFixed(2);
            
            estadisticasDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">${totalDatos}</div>
                        <div style="font-size: 0.8rem; color: #666;">Datos Completados</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color);">${totalInsumos}</div>
                        <div style="font-size: 0.8rem; color: #666;">Insumos Registrados</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--secondary-color);">${totalCategorias}</div>
                        <div style="font-size: 0.8rem; color: #666;">Categor√≠as √önicas</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">${espacioKB} KB</div>
                        <div style="font-size: 0.8rem; color: #666;">Espacio Usado</div>
                    </div>
                </div>
            `;
        }

        // ========== FUNCIONES DE AYUDA ==========

        function mostrarAcercaDe() {
            alert(`TopCal v2.0\n\nSistema de Cotizaciones Topogr√°ficas\nDesarrollado por Lithman Morales\n\n¬© 2026 - Todos los derechos reservados\n\nCaracter√≠sticas:\n‚Ä¢ Gesti√≥n completa de cotizaciones\n‚Ä¢ Exportaci√≥n PDF\n‚Ä¢ Configuraci√≥n personalizable`);
        }

        // ========== INICIALIZACI√ìN ==========

        window.addEventListener('DOMContentLoaded', function() {
            // Establecer fecha predeterminada
            const fechaInput = document.getElementById('fecha');
            const hoy = new Date();
            fechaInput.value = hoy.toISOString().split('T')[0];
            
            // Cargar datos guardados
            try {
                const datosGuardados = localStorage.getItem('topcal_datos_v2');
                if (datosGuardados) {
                    datosGenerales = JSON.parse(datosGuardados);
                    Object.keys(datosGenerales).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) element.value = datosGenerales[key] || '';
                    });
                }
                
                const insumosGuardados = localStorage.getItem('topcal_insumos_v2');
                if (insumosGuardados) {
                    const datos = JSON.parse(insumosGuardados);
                    insumos = datos.insumos || [];
                    mostrarInsumos();
                    actualizarEstadisticasInsumos();
                }
                
                const configGuardada = localStorage.getItem('topcal_config_v2');
                if (configGuardada) {
                    configuracion = JSON.parse(configGuardada);
                    document.getElementById('configIGV').value = configuracion.igv || 18;
                    document.getElementById('configUtilidad').value = configuracion.utilidad || 20;
                    document.getElementById('configRUC').value = configuracion.ruc || '';
                    
                    // ¬°IMPORTANTE! CARGAR EL MARGEN EN INSUMOS AL INICIAR
                    const margenInsumos = document.getElementById('margenUtilidad');
                    if (margenInsumos) {
                        margenInsumos.value = configuracion.utilidad || 20;
                        console.log('‚úÖ Margen inicial cargado:', configuracion.utilidad + '%');
                    }
                } else {
                    // Si no hay configuraci√≥n, usar valores por defecto
                    const margenInsumos = document.getElementById('margenUtilidad');
                    if (margenInsumos) {
                        margenInsumos.value = 20;
                    }
                }
                
                // Mostrar mensaje de bienvenida
                setTimeout(() => {
                    if (insumos.length > 0) {
                        showAlert('alertDatosGenerales', 
                            `üéâ Bienvenido de nuevo a TopCal Professional<br>
                            <small>Se cargaron ${insumos.length} insumos de su sesi√≥n anterior</small>`, 
                            'success');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
            
            // Validaci√≥n en tiempo real
            document.querySelectorAll('#tab-1 input[required], #tab-1 select[required]').forEach(field => {
                field.addEventListener('blur', validarFormularioDatos);
                field.addEventListener('input', actualizarEstadisticasDatos);
            });
            
            // Actualizar estad√≠sticas iniciales
            actualizarEstadisticasDatos();
            actualizarEstadisticasSistema();
            actualizarInfoProyecto();
            
            // Sincronizar margen de utilidad en tiempo real
            const configUtilidadInput = document.getElementById('configUtilidad');
            if (configUtilidadInput) {
                configUtilidadInput.addEventListener('change', function() {
                    // Actualizar tambi√©n el campo en la pesta√±a de insumos
                    const margenInsumos = document.getElementById('margenUtilidad');
                    if (margenInsumos) {
                        margenInsumos.value = this.value;
                        console.log('‚úÖ Margen actualizado en tiempo real:', this.value + '%');
                    }
                });
            }
        });
        

        // Guardado autom√°tico antes de salir
        window.addEventListener('beforeunload', function(e) {
            if (insumos.length > 0 || (datosGenerales && datosGenerales.cliente)) {
                guardarInsumosAuto();
                if (datosGenerales.cliente) {
                    localStorage.setItem('topcal_datos_v2', JSON.stringify(datosGenerales));
                }
                
                // Preguntar antes de salir si hay datos no guardados
                e.preventDefault();
                e.returnValue = '¬øEst√° seguro de salir? Los cambios podr√≠an no guardarse.';
                return e.returnValue;
            }
        });

        // Detectar cambios en inputs para validaci√≥n
        document.addEventListener('input', function(e) {
            if (e.target.matches('input[required], select[required], textarea[required]')) {
                if (e.target.value.trim()) {
                    e.target.style.borderColor = 'var(--success-color)';
                } else {
                    e.target.style.borderColor = 'var(--danger-color)';
                }
            }
        });

        // Funci√≥n para diagnosticar el problema del margen
        function diagnosticarMargenUtilidad() {
            console.group('üîç DIAGN√ìSTICO DE MARGEN DE UTILIDAD');
            
            // Mostrar configuraci√≥n actual
            console.log('üìä Configuraci√≥n actual:');
            console.log('- Margen en configuraci√≥n:', configuracion.utilidad + '%');
            console.log('- Margen en campo insumos:', document.getElementById('margenUtilidad').value + '%');
            
            // Analizar insumos
            console.log('üì¶ An√°lisis de insumos:');
            if (insumos.length === 0) {
                console.log('No hay insumos para analizar');
            } else {
                console.log(`Total insumos: ${insumos.length}`);
                
                const margenesUnicos = [...new Set(insumos.map(i => i.margenUtilidad))];
                console.log('Margenes √∫nicos encontrados:', margenesUnicos);
                
                // Mostrar los 5 primeros insumos con sus c√°lculos
                insumos.slice(0, 5).forEach((insumo, index) => {
                    console.log(`Insumo ${index + 1}:`);
                    console.log(`  Descripci√≥n: ${insumo.descripcion}`);
                    console.log(`  Margen: ${insumo.margenUtilidad}%`);
                    console.log(`  Costo unitario: ${insumo.costoUnitario}`);
                    console.log(`  Cantidad: ${insumo.cantidad}`);
                    console.log(`  Subtotal: ${insumo.cantidad * insumo.costoUnitario}`);
                    console.log(`  Utilidad calculada: ${insumo.cantidad * insumo.costoUnitario * (insumo.margenUtilidad / 100)}`);
                    console.log(`  Utilidad guardada: ${insumo.utilidad}`);
                    console.log(`  Diferencia: ${Math.abs(insumo.utilidad - (insumo.cantidad * insumo.costoUnitario * (insumo.margenUtilidad / 100)))}`);
                });
            }
            
            console.groupEnd();
        }

        // Para ejecutar diagn√≥stico, abre la consola (F12) y escribe: diagnosticarMargenUtilidad()
    </script>
</body>
</html>